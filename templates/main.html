<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Hall Portal - Christmas Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800;900&family=Fredoka+One&display=swap" rel="stylesheet">

<style>
        /* ========================================
           GLOBAL RESET & BASE STYLES
        ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --christmas-red: #d32f2f;
            --christmas-red-dark: #b71c1c;
            --christmas-red-light: #ef5350;
            --christmas-white: #ffffff;
            --christmas-snow: #f8f9fa;
            --christmas-cream: #fffaf5;
            --christmas-gold: #ffd700;
            --christmas-gold-dark: #d4af37;
            --text-dark: #1a1a1a;
            --text-medium: #4a4a4a;
            --text-light: #888888;
            --border-main: #2c2c2c;
            --shadow-cartoon: 0 6px 0 rgba(44, 44, 44, 0.9);
            --shadow-cartoon-sm: 0 4px 0 rgba(44, 44, 44, 0.9);
            --shadow-cartoon-hover: 0 8px 0 rgba(44, 44, 44, 0.9);
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(180deg, #1a1f2e 0%, #252d3d 50%, #1a1f2e 100%);
            background-attachment: fixed;
            color: var(--text-dark);
            padding: 1.5rem;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* ========================================
   ENHANCED SNOWFALL - BIG BURST THEN FADE
======================================== */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image:
        radial-gradient(5px 5px at 8% 12%, rgba(255,255,255,0.98), transparent),
        radial-gradient(4px 4px at 18% 45%, rgba(255,255,255,0.95), transparent),
        radial-gradient(5px 5px at 28% 25%, rgba(255,255,255,0.96), transparent),
        radial-gradient(4px 4px at 38% 75%, rgba(255,255,255,0.92), transparent),
        radial-gradient(6px 6px at 48% 40%, rgba(255,255,255,0.94), transparent),
        radial-gradient(4px 4px at 58% 85%, rgba(255,255,255,0.90), transparent),
        radial-gradient(5px 5px at 68% 20%, rgba(255,255,255,0.97), transparent),
        radial-gradient(4px 4px at 78% 60%, rgba(255,255,255,0.91), transparent),
        radial-gradient(6px 6px at 88% 35%, rgba(255,255,255,0.95), transparent),
        radial-gradient(4px 4px at 98% 70%, rgba(255,255,255,0.89), transparent);
    background-size: 120px 120px, 160px 160px, 140px 140px, 180px 180px, 130px 130px, 200px 200px, 150px 150px, 190px 190px, 125px 125px, 170px 170px;
    animation: snowfallFade 15s linear forwards;
    pointer-events: none;
    z-index: 9999;
}

body::after {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image:
        radial-gradient(3px 3px at 12% 30%, rgba(255,255,255,0.75), transparent),
        radial-gradient(2px 2px at 35% 65%, rgba(255,255,255,0.65), transparent),
        radial-gradient(3px 3px at 55% 45%, rgba(255,255,255,0.70), transparent),
        radial-gradient(2px 2px at 75% 80%, rgba(255,255,255,0.60), transparent),
        radial-gradient(3px 3px at 92% 55%, rgba(255,255,255,0.68), transparent);
    background-size: 250px 250px, 300px 300px, 230px 230px, 350px 350px, 270px 270px;
    background-position: 15px 25px, 70px 90px, 140px 50px, 190px 140px, 90px 180px;
    animation: snowfallFade 20s linear forwards;
    pointer-events: none;
    z-index: 9998;
}

@keyframes snowfallFade {
    0% {
        transform: translateY(-10%);
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
    100% {
        transform: translateY(105vh);
        opacity: 0;
    }
}
        /* ========================================
           MAIN CONTAINER WITH CHRISTMAS DECORATIONS
        ======================================== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--christmas-cream);
            padding: 2.5rem;
            border-radius: 32px;
            border: 6px solid var(--border-main);
            box-shadow: var(--shadow-cartoon), 0 20px 60px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        /* Christmas header decoration */
        .container::before {
            content: 'üéÑ StudyHall';
            position: absolute;
            top: -3px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 1.5rem;
            font-family: 'Fredoka One', cursive;
            background: linear-gradient(135deg, var(--christmas-red) 0%, var(--christmas-red-dark) 100%);
            padding: 0.75rem 0;
            border-bottom: 5px solid var(--border-main);
            letter-spacing: 3px;
            color: white;
        }

        /* ========================================
           HEADER STYLES
        ======================================== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 5px solid var(--border-main);
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.2rem;
        }

        .santa-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--christmas-red) 0%, var(--christmas-red-dark) 100%);
            border-radius: 50%;
            border: 5px solid var(--border-main);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: 0 5px 0 rgba(44, 44, 44, 0.9), 0 0 30px rgba(211, 47, 47, 0.5);
        }

        .header h2 {
            font-family: 'Fredoka One', cursive;
            font-weight: 400;
            font-size: 2.2rem;
            color: var(--text-dark);
            letter-spacing: 1px;
            text-shadow: 3px 3px 0 rgba(255, 255, 255, 0.5);
            line-height: 1.2;
        }

        .header h2 .holiday-accent {
            color: var(--christmas-red);
            display: block;
            font-size: 1.6rem;
            text-shadow:
                2px 2px 0 rgba(0, 0, 0, 0.1),
                0 0 20px rgba(211, 47, 47, 0.4);
        }

        .header-buttons {
            display: flex;
            gap: 0.8rem;
            align-items: center;
            flex-wrap: wrap;
        }

        /* ========================================
           BUTTON STYLES
        ======================================== */
        .btn {
            background: var(--christmas-white);
            border: 4px solid var(--border-main);
            padding: 0.75rem 1.4rem;
            border-radius: 16px;
            color: var(--text-dark);
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 800;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-cartoon-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }

        .btn:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 0 rgba(44, 44, 44, 0.9), 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(2px) scale(0.98);
            box-shadow: 0 2px 0 rgba(44, 44, 44, 0.9);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--christmas-red) 0%, var(--christmas-red-dark) 100%);
            color: white;
            border-color: var(--border-main);
            box-shadow:
                var(--shadow-cartoon-sm),
                0 0 20px rgba(211, 47, 47, 0.4);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--christmas-red-light) 0%, var(--christmas-red) 100%);
            box-shadow:
                0 8px 0 rgba(44, 44, 44, 0.9),
                0 0 30px rgba(211, 47, 47, 0.6);
        }

        /* ========================================
           TOKENS DISPLAY - CHUNKY CARTOON STYLE
        ======================================== */
        .tokens-display {
            background: linear-gradient(135deg, var(--christmas-gold) 0%, var(--christmas-gold-dark) 100%);
            padding: 0.8rem 1.6rem;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            border: 6px solid var(--christmas-white);
            outline: 5px solid var(--border-main);
            box-shadow:
                var(--shadow-cartoon-sm),
                0 0 25px rgba(255, 215, 0, 0.5);
            position: relative;
        }

        .tokens-display::before {
            content: 'üéüÔ∏è';
            font-size: 1.6rem;
        }

        .token-amount {
            font-family: 'Fredoka One', cursive;
            font-size: 1.8rem;
            font-weight: 400;
            color: white;
            text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
        }

        .unread-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--christmas-red);
            color: white;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 900;
            border: 4px solid var(--border-main);
            box-shadow: 0 3px 0 rgba(44, 44, 44, 0.9);
            animation: badgePulse 1.5s ease-in-out infinite;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        /* ========================================
           PROFILE BUTTON
        ======================================== */
        .profile-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 5px solid var(--border-main);
            background: var(--christmas-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            overflow: hidden;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-cartoon-sm);
        }

        .profile-btn:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 0 rgba(44, 44, 44, 0.9);
        }

        .profile-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ========================================
           ANNOUNCEMENTS (UPDATED STYLE)
        ======================================== */
        .announcements {
            margin-bottom: 2rem;
        }

        .announcement {
            background: linear-gradient(135deg, var(--christmas-red) 0%, var(--christmas-red-dark) 100%);
            border-radius: 20px;
            padding: 1.3rem 2rem;
            margin-bottom: 1rem;
            text-align: center;
            border: 5px solid var(--border-main);
            box-shadow:
                var(--shadow-cartoon),
                inset 0 2px 0 rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .announcement-text {
            color: white;
            margin-bottom: 0.4rem;
            font-weight: 800;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
        }

        .announcement-time {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
        }

        /* ========================================
           TABS NAVIGATION
        ======================================== */
        .tabs-container {
            display: flex;
            gap: 0.6rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            background: var(--christmas-white);
            padding: 0.7rem;
            border-radius: 20px;
            width: fit-content;
            border: 5px solid var(--border-main);
            box-shadow: var(--shadow-cartoon-sm);
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 0.85rem 1.6rem;
            font-size: 1rem;
            font-weight: 800;
            color: var(--text-medium);
            cursor: pointer;
            border-radius: 14px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tab-btn:hover {
            background: var(--christmas-snow);
            color: var(--text-dark);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--christmas-red) 0%, var(--christmas-red-dark) 100%);
            color: white;
            border: 4px solid var(--border-main);
            box-shadow: 0 4px 0 rgba(44, 44, 44, 0.9), inset 0 2px 0 rgba(255, 255, 255, 0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ========================================
           SEARCH BOX
        ======================================== */
        .search-container {
            margin-bottom: 2rem;
        }

        .search-box {
            width: 100%;
            max-width: 450px;
            padding: 1rem 1.3rem;
            padding-left: 3rem;
            border: 5px solid var(--border-main);
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 700;
            font-family: inherit;
            background: var(--christmas-white);
            color: var(--text-dark);
            transition: all 0.2s ease;
            box-shadow: var(--shadow-cartoon-sm);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23888888'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 1rem center;
            background-size: 1.3rem;
        }

        .search-box::placeholder {
            color: var(--text-light);
        }

        .search-box:focus {
            outline: none;
            border-color: var(--christmas-red);
            box-shadow:
                var(--shadow-cartoon-sm),
                0 0 0 4px rgba(211, 47, 47, 0.2);
        }

        /* ========================================
           GAME SECTION HEADERS
        ======================================== */
        .game-section {
            margin-bottom: 1.5rem;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.3rem 1.5rem;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border: 5px solid var(--border-main);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0;
            box-shadow: var(--shadow-cartoon-sm);
        }

        .section-header:hover {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 0 rgba(44, 44, 44, 0.9);
        }

        .section-header.expanded {
            border-radius: 20px 20px 0 0;
            border-bottom: none;
            box-shadow: none;
            transform: none;
        }

        .section-header-left {
            display: flex;
            align-items: center;
            gap: 1.2rem;
        }

        .section-title {
            font-family: 'Fredoka One', cursive;
            font-weight: 400;
            font-size: 1.4rem;
            color: var(--text-dark);
            letter-spacing: 0.5px;
        }

        .section-count {
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 700;
            margin-top: 0.2rem;
            text-transform: none;
        }

        .section-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--christmas-white);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: 4px solid var(--border-main);
            box-shadow: 0 3px 0 rgba(44, 44, 44, 0.7);
        }

        .section-toggle svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-medium);
            stroke-width: 3;
            transition: transform 0.3s ease;
        }

        .section-header:hover .section-toggle {
            background: var(--christmas-red);
            transform: scale(1.1);
        }

        .section-header:hover .section-toggle svg {
            stroke: white;
        }

        .section-header.expanded .section-toggle svg {
            transform: rotate(180deg);
        }

        .games-grid-wrapper {
            display: none;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border: 5px solid var(--border-main);
            border-top: none;
            border-radius: 0 0 20px 20px;
            padding: 1.5rem;
            box-shadow: var(--shadow-cartoon-sm);
            animation: slideDown 0.3s ease;
        }

        .games-grid-wrapper.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ========================================
           GAME CARDS
        ======================================== */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.2rem;
        }

        .game-card {
            background: var(--christmas-white);
            border: 5px solid var(--border-main);
            border-radius: 18px;
            padding: 1.5rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            min-height: 160px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-cartoon-sm);
        }

        .game-card::before {
            content: 'üéÅ';
            position: absolute;
            bottom: -15px;
            right: -15px;
            font-size: 6rem;
            opacity: 0.05;
            transform: rotate(-15deg);
            transition: all 0.3s ease;
        }

        .game-card:hover::before {
            transform: rotate(-15deg) scale(1.1);
            opacity: 0.08;
        }

        .game-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow:
                0 10px 0 rgba(44, 44, 44, 0.9),
                0 15px 35px rgba(211, 47, 47, 0.2);
            border-color: var(--christmas-red);
        }

        .game-card.unavailable {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(0.7);
        }

        .game-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            position: relative;
            z-index: 2;
        }

        .game-title {
            font-size: 1.15rem;
            font-weight: 900;
            color: var(--text-dark);
            line-height: 1.3;
            flex: 1;
            padding-right: 0.5rem;
        }

        .game-badge {
            display: inline-flex;
            padding: 0.35rem 0.8rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            border: 3px solid var(--border-main);
            box-shadow: 0 2px 0 rgba(44, 44, 44, 0.5);
        }

        .badge-free {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
        }

        .badge-price {
            background: linear-gradient(135deg, var(--christmas-gold) 0%, var(--christmas-gold-dark) 100%);
            color: var(--text-dark);
        }

        .badge-owned {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .badge-maintenance {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .game-card-footer {
            margin-top: auto;
            position: relative;
            z-index: 2;
        }

        .play-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--christmas-red) 0%, var(--christmas-red-dark) 100%);
            color: white;
            border: 4px solid var(--border-main);
            padding: 0.85rem 1.2rem;
            font-size: 0.95rem;
            font-weight: 900;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: block;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 0 rgba(44, 44, 44, 0.9);
        }

        .play-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 0 rgba(44, 44, 44, 0.9), 0 10px 25px rgba(211, 47, 47, 0.3);
        }

        .play-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(44, 44, 44, 0.9);
        }

        .play-btn.purchase {
            background: linear-gradient(135deg, var(--christmas-gold) 0%, var(--christmas-gold-dark) 100%);
            color: var(--text-dark);
        }

        .play-btn.disabled {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            cursor: not-allowed;
            pointer-events: none;
        }

        /* ========================================
           TOKENS TAB
        ======================================== */
        .tokens-content {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border: 5px solid var(--border-main);
            border-radius: 24px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-cartoon);
            position: relative;
            overflow: hidden;
        }
        .tokens-content::before {
        content: '‚ùÑÔ∏è';
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 4rem;
        opacity: 0.08;
        animation: snowflakeRotate 10s linear infinite;
    }

    @keyframes snowflakeRotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .tokens-content h2 {
        font-family: 'Fredoka One', cursive;
        font-weight: 400;
        font-size: 2rem;
        margin-bottom: 0.5rem;
        color: var(--christmas-red);
        text-align: center;
        text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.1);
    }

    .tokens-content p.subtitle {
        text-align: center;
        color: var(--text-light);
        font-size: 1rem;
        margin-bottom: 2rem;
        font-weight: 700;
    }

    /* ========================================
       ADVENT CALENDAR
    ======================================== */
    .advent-calendar-container {
        max-width: 800px;
        margin: 2rem auto;
        position: relative;
    }

    .advent-tree {
        display: grid;
        gap: 0.8rem;
        justify-items: center;
        padding: 1rem;
    }

    /* Christmas tree shape layout */
    .tree-row {
        display: flex;
        gap: 0.8rem;
        justify-content: center;
    }

    .advent-door {
        width: 80px;
        height: 80px;
        border-radius: 16px;
        border: 5px solid var(--border-main);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        font-size: 1.8rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-cartoon-sm);
        position: relative;
        overflow: hidden;
    }

    .advent-door-number {
        font-size: 0.75rem;
        font-weight: 900;
        position: absolute;
        top: 4px;
        left: 8px;
        background: rgba(0, 0, 0, 0.3);
        color: white;
        padding: 2px 6px;
        border-radius: 6px;
        z-index: 2;
    }

    /* Locked state (future doors) */
    .advent-door.locked {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: rgba(255, 255, 255, 0.3);
        cursor: not-allowed;
        filter: grayscale(0.8);
    }

    /* Available state (can open today) */
    .advent-door.available {
        background: linear-gradient(135deg, var(--christmas-red) 0%, var(--christmas-red-dark) 100%);
        color: white;
        animation: doorPulse 2s ease-in-out infinite;
        box-shadow:
            var(--shadow-cartoon-sm),
            0 0 30px rgba(211, 47, 47, 0.6);
    }

    .advent-door.available:hover {
        transform: translateY(-6px) scale(1.1) rotate(5deg);
        box-shadow:
            0 8px 0 rgba(44, 44, 44, 0.9),
            0 0 40px rgba(255, 215, 0, 0.8);
    }

    /* Opened state */
    .advent-door.opened {
        background: linear-gradient(135deg, var(--christmas-gold) 0%, var(--christmas-gold-dark) 100%);
        color: var(--text-dark);
        cursor: default;
        border-color: var(--christmas-gold-dark);
    }

    .advent-door.opened::after {
        content: '‚úì';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3rem;
        color: rgba(255, 255, 255, 0.9);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* Missed state (past door not opened) */
    .advent-door.missed {
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
        color: rgba(255, 255, 255, 0.4);
        cursor: not-allowed;
        opacity: 0.6;
    }

    @keyframes doorPulse {
        0%, 100% {
            box-shadow:
                var(--shadow-cartoon-sm),
                0 0 20px rgba(211, 47, 47, 0.4);
        }
        50% {
            box-shadow:
                var(--shadow-cartoon-sm),
                0 0 40px rgba(255, 215, 0, 0.8);
        }
    }

    .advent-message {
        background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
        border: 4px solid var(--border-main);
        padding: 1.2rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        text-align: center;
        font-weight: 900;
        color: white;
        min-height: 30px;
        box-shadow: var(--shadow-cartoon-sm);
        font-size: 1.05rem;
        display: none;
    }

    .advent-message.show {
        display: block;
    }

    .advent-message.error {
        background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
    }

    /* Game selection modal styles */
    .game-select-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
        max-height: 400px;
        overflow-y: auto;
    }

    .game-select-card {
        background: var(--christmas-white);
        border: 4px solid var(--border-main);
        border-radius: 16px;
        padding: 1.2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-cartoon-sm);
    }

    .game-select-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 0 rgba(44, 44, 44, 0.9);
        border-color: var(--christmas-gold);
    }

    .game-select-card h4 {
        font-weight: 900;
        font-size: 1rem;
        margin-bottom: 0.5rem;
        color: var(--text-dark);
    }

    .game-select-card .game-price {
        font-size: 0.85rem;
        color: var(--christmas-gold-dark);
        font-weight: 800;
    }

    .balance-display {
    font-family: 'Fredoka One', cursive;
    font-size: 2.8rem;
    font-weight: 400;
    color: var(--christmas-red);
    text-align: center;
    margin: 2rem 0;
    text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.1);
}

    cursor: not-allowed;
    color: #d1d5db;
}

/* ========================================
   LEADERBOARD
======================================== */
.leaderboard-container {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border: 5px solid var(--border-main);
    border-radius: 24px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-cartoon);
}

.leaderboard-container h3 {
    font-family: 'Fredoka One', cursive;
    font-weight: 400;
    font-size: 1.8rem;
    margin-bottom: 1.5rem;
    color: var(--christmas-red);
    text-align: center;
}

.leaderboard-list {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.leaderboard-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    background: var(--christmas-white);
    border: 4px solid var(--border-main);
    border-radius: 16px;
    box-shadow: 0 3px 0 rgba(44, 44, 44, 0.7);
    transition: all 0.2s ease;
}

.leaderboard-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 0 rgba(44, 44, 44, 0.7);
}

.leaderboard-rank {
    font-size: 1.5rem;
    font-weight: 900;
    min-width: 50px;
    text-align: center;
}

.leaderboard-name {
    flex: 1;
    font-weight: 800;
    font-size: 1.05rem;
    color: var(--text-dark);
}

.leaderboard-tokens {
    font-weight: 900;
    font-size: 1.1rem;
    color: var(--christmas-gold-dark);
}

/* ========================================
   CODE REDEMPTION
======================================== */
.code-container {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border: 5px solid var(--border-main);
    border-radius: 24px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-cartoon);
}

.code-container h3 {
    font-family: 'Fredoka One', cursive;
    font-weight: 400;
    font-size: 1.8rem;
    margin-bottom: 1.5rem;
    color: var(--christmas-red);
    text-align: center;
}

.code-input-group {
    display: flex;
    gap: 0.8rem;
    max-width: 500px;
    margin: 0 auto;
}

.code-input-group input {
    flex: 1;
    padding: 1rem 1.3rem;
    border: 5px solid var(--border-main);
    border-radius: 16px;
    font-size: 1rem;
    font-weight: 700;
    font-family: inherit;
    background: var(--christmas-white);
    color: var(--text-dark);
    text-transform: uppercase;
}

.code-input-group input:focus {
    outline: none;
    border-color: var(--christmas-red);
}

#codeMessage {
    margin-top: 1rem;
    text-align: center;
    font-weight: 800;
    padding: 0.8rem;
    border-radius: 12px;
    display: none;
}

#codeMessage.success {
    background: #4ade80;
    color: white;
    display: block;
}

#codeMessage.error {
    background: #ff4444;
    color: white;
    display: block;
}

/* ========================================
   RANK PASS
======================================== */
.rank-container {
    margin-top: 2rem;
}

.rank-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.rank-card {
    background: var(--christmas-white);
    border: 4px solid var(--border-main);
    border-radius: 16px;
    padding: 1.5rem 1rem;
    text-align: center;
    box-shadow: var(--shadow-cartoon-sm);
    transition: all 0.2s ease;
}

.rank-card.active {
    border-color: var(--christmas-gold);
    transform: scale(1.05);
    box-shadow: 0 6px 0 rgba(44, 44, 44, 0.9), 0 0 20px rgba(255, 215, 0, 0.5);
}

.rank-card.claimed {
    opacity: 0.6;
    filter: grayscale(0.5);
}

.rank-card-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.rank-card-name {
    font-weight: 900;
    font-size: 0.95rem;
    margin-bottom: 0.3rem;
    color: var(--text-dark);
}

.rank-card-tokens {
    font-weight: 800;
    font-size: 0.85rem;
    color: var(--christmas-gold-dark);
}

.rank-claim-btn {
    width: 100%;
    background: linear-gradient(135deg, var(--christmas-gold) 0%, var(--christmas-gold-dark) 100%);
    color: var(--text-dark);
    border: 5px solid var(--border-main);
    padding: 1.2rem 2rem;
    font-size: 1.1rem;
    font-weight: 900;
    border-radius: 18px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: var(--shadow-cartoon);
}

.rank-claim-btn:hover:not(:disabled) {
    transform: translateY(-4px);
    box-shadow: 0 10px 0 rgba(44, 44, 44, 0.9), 0 15px 35px rgba(255, 215, 0, 0.4);
}

.rank-claim-btn:active:not(:disabled) {
    transform: translateY(3px);
    box-shadow: 0 3px 0 rgba(44, 44, 44, 0.9);
}

.rank-claim-btn:disabled {
    background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
    cursor: not-allowed;
    color: #d1d5db;
}

#rankPassMessage {
    text-align: center;
    margin-bottom: 1.5rem;
    font-weight: 800;
    font-size: 1.05rem;
}

/* ========================================
   SHOP TAB
======================================== */
.shop-container {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border: 5px solid var(--border-main);
    border-radius: 24px;
    padding: 2.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-cartoon);
}

.shop-container h2 {
    font-family: 'Fredoka One', cursive;
    font-weight: 400;
    font-size: 2.2rem;
    margin-bottom: 2rem;
    color: var(--christmas-red);
    text-align: center;
}

.shop-section {
    margin-bottom: 2.5rem;
}

.shop-section h3 {
    font-family: 'Fredoka One', cursive;
    font-weight: 400;
    font-size: 1.6rem;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
}

.shop-section p {
    color: var(--text-light);
    margin-bottom: 1.5rem;
    font-weight: 600;
}

.rank-shop-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.rank-shop-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.2rem 1.5rem;
    background: var(--christmas-white);
    border: 4px solid var(--border-main);
    border-radius: 16px;
    box-shadow: var(--shadow-cartoon-sm);
    transition: all 0.2s ease;
}

.rank-shop-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 7px 0 rgba(44, 44, 44, 0.9);
}

.rank-shop-item.locked {
    opacity: 0.5;
    filter: grayscale(0.7);
}

.rank-shop-info {
    flex: 1;
}

.rank-shop-name {
    font-weight: 900;
    font-size: 1.2rem;
    margin-bottom: 0.3rem;
}

.rank-shop-price {
    font-weight: 800;
    font-size: 0.95rem;
    color: var(--christmas-gold-dark);
}

.rank-shop-actions {
    display: flex;
    gap: 0.8rem;
}

/* ========================================
   FEEDBACK SECTION
======================================== */
.feedback-section {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border: 5px solid var(--border-main);
    border-radius: 24px;
    padding: 2.5rem;
    margin-top: 2rem;
    box-shadow: var(--shadow-cartoon);
}

.feedback-section h3 {
    font-family: 'Fredoka One', cursive;
    font-weight: 400;
    font-size: 1.8rem;
    margin-bottom: 1.5rem;
    color: var(--christmas-red);
    text-align: center;
}

.feedback-textarea {
    width: 100%;
    min-height: 120px;
    padding: 1rem 1.3rem;
    border: 5px solid var(--border-main);
    border-radius: 16px;
    font-size: 1rem;
    font-weight: 600;
    font-family: inherit;
    background: var(--christmas-white);
    color: var(--text-dark);
    resize: vertical;
    margin-bottom: 1rem;
}

.feedback-textarea:focus {
    outline: none;
    border-color: var(--christmas-red);
}

/* ========================================
   MODALS
======================================== */
.modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--christmas-cream);
    border: 6px solid var(--border-main);
    border-radius: 24px;
    padding: 2rem;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow-cartoon), 0 20px 60px rgba(0, 0, 0, 0.5);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 4px solid var(--border-main);
}

.modal-title {
    font-family: 'Fredoka One', cursive;
    font-weight: 400;
    font-size: 1.8rem;
    color: var(--christmas-red);
}

.modal-close {
    background: var(--christmas-red);
    color: white;
    border: 4px solid var(--border-main);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    transition: all 0.2s ease;
    box-shadow: 0 3px 0 rgba(44, 44, 44, 0.7);
}

.modal-close:hover {
    transform: scale(1.1) rotate(90deg);
}

/* Lunch menu styles */
.lunch-today, .lunch-tomorrow {
    background: var(--christmas-white);
    border: 4px solid var(--border-main);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: var(--shadow-cartoon-sm);
}

.lunch-label {
    font-weight: 900;
    font-size: 0.85rem;
    color: var(--christmas-red);
    text-transform: uppercase;
    margin-bottom: 0.5rem;
    letter-spacing: 0.5px;
}

.lunch-food {
    font-weight: 800;
    font-size: 1.2rem;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
}

.lunch-fact {
    font-size: 0.9rem;
    color: var(--text-light);
    font-weight: 600;
    font-style: italic;
    padding-top: 0.5rem;
    border-top: 2px solid var(--christmas-snow);
}

/* ========================================
   CHAT NOTIFICATION
======================================== */
#chatNotificationContainer {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
}

.chat-notification {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 5px solid var(--christmas-gold);
    border-radius: 20px;
    padding: 1rem 1.5rem;
    min-width: 300px;
    max-width: 400px;
    box-shadow: 0 8px 0 #2C2C2C, 0 12px 30px rgba(255, 215, 0, 0.5);
    cursor: pointer;
    transition: all 0.3s ease;
    animation: slideInRight 0.4s ease-out;
    margin-bottom: 1rem;
}

.chat-notification:hover {
    transform: translateY(-3px) translateX(-5px);
    box-shadow: 0 12px 0 #2C2C2C, 0 16px 40px rgba(255, 215, 0, 0.6);
}

.chat-notification:active {
    transform: translateY(1px);
    box-shadow: 0 4px 0 #2C2C2C;
}

@keyframes slideInRight {
    from { transform: translateX(450px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOutRight {
    to { transform: translateX(450px); opacity: 0; }
}

.chat-notification.hiding {
    animation: slideOutRight 0.3s ease-in forwards;
}

.notification-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.notification-icon {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: var(--christmas-gold);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    border: 4px solid #2C2C2C;
    box-shadow: 0 3px 0 rgba(44, 44, 44, 0.5);
}

.notification-content { flex: 1; }

.notification-title {
    font-weight: 900;
    font-size: 0.9rem;
    color: var(--christmas-gold);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.notification-user {
    font-weight: 700;
    font-size: 1.1rem;
    color: #ffffff;
    margin-top: 0.25rem;
}

.notification-action {
    font-size: 0.75rem;
    color: #888;
    margin-top: 0.25rem;
    font-weight: 600;
}

.notification-close {
    background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
    border: 3px solid #2C2C2C;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 3px 0 #2C2C2C;
    font-weight: 900;
}

.notification-close:hover {
    transform: rotate(90deg) scale(1.1);
}

/* ========================================
   RESPONSIVE DESIGN
======================================== */
@media (max-width: 768px) {
    body {
        padding: 1rem;
    }

    .container {
        padding: 1.5rem;
    }

    .container::before {
        font-size: 1.2rem;
        letter-spacing: 2px;
    }

    .santa-icon {
        width: 55px;
        height: 55px;
        font-size: 2rem;
    }

    .header h2 {
        font-size: 1.8rem;
    }

    .header h2 .holiday-accent {
        font-size: 1.3rem;
    }

    .header {
        flex-direction: column;
        align-items: stretch;
        margin-top: 3.5rem;
    }

    .header-buttons {
        justify-content: center;
    }

    .games-grid {
        grid-template-columns: 1fr;
    }

    .tabs-container {
        width: 100%;
    }

    .tab-btn {
        flex: 1;
        justify-content: center;
        padding: 0.7rem 1rem;
        font-size: 0.9rem;
    }

    .ladder-container {
        padding-left: 50px;
    }

    .ladder-present {
        left: -50px;
        font-size: 2rem;
    }
}</style>
</head>
<body>
    <!-- Background Music -->
    <audio id="bgMusic" loop>
        <source src="{{ url_for('static', filename='studyhall.mp3') }}" type="audio/mpeg">
    </audio>
    <script>
    window.addEventListener('DOMContentLoaded', function() {
        const audio = document.getElementById('bgMusic');
        audio.volume = 0.8;
        const playPromise = audio.play();
        if (playPromise !== undefined) {
            playPromise.catch(function() {
                const startAudio = function() {
                    audio.play();
                    document.removeEventListener('click', startAudio);
                    document.removeEventListener('keydown', startAudio);
                };
                document.addEventListener('click', startAudio);
                document.addEventListener('keydown', startAudio);
            });
        }
    });
</script>
<div class="container">
    <!-- Header Section -->
    <div class="header">
        <div class="header-left">
            <div class="santa-icon">üéÑ</div>
            <h2>
                Welcome Back!
                <span class="holiday-accent">{{ session.username }}</span>
            </h2>
        </div>
        <div class="header-buttons">
            <a href="{{ url_for('profile') }}" class="profile-btn">
                {% if session.username in profiles and profiles.get(session.username, {}).get('setup_complete', False) and profiles.get(session.username, {}).get('profile_picture') %}
                <img src="{{ profiles[session.username]['profile_picture'] }}" alt="Profile">
                {% else %}
                üéÖ
                {% endif %}
            </a>
            <div class="tokens-display">
                <span class="token-amount">{{ users[session.username]['tokens'] }}</span>
            </div>
            <button onclick="showLunchMenu()" class="btn">üçΩÔ∏è Lunch</button>
            <a href="{{ url_for('lounge') }}" class="btn" style="position: relative;">
                üè† Lounge
                {% if lounge_unread_count > 0 %}
                <span class="unread-badge">{{ lounge_unread_count }}</span>
                {% endif %}
            </a>
            <a href="{{ url_for('chat') }}" class="btn" style="position: relative;">
                üí¨ Chat
                {% if unread_count > 0 %}
                <span class="unread-badge">{{ unread_count }}</span>
                {% endif %}
            </a>
            <a href="{{ url_for('logout') }}" class="btn btn-primary">Logout</a>
        </div>
    </div><!-- ========================================
     ANNOUNCEMENTS
======================================== -->
{% if announcements %}
<div class="announcements">
    {% for announcement in announcements %}
    <div class="announcement">
        <div class="announcement-text">{{ announcement.text }}</div>
        <div class="announcement-time">{{ announcement.timestamp | format_time }}</div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- ========================================
     TABS NAVIGATION
======================================== -->
<div class="tabs-container">
    <button class="tab-btn active" onclick="switchTab('games', this)">Games</button>
<button class="tab-btn" onclick="switchTab('tokens', this)">Tokens</button>
<button class="tab-btn" onclick="switchTab('shop', this)">Shop</button>
    <a href="{{ url_for('casino') }}" class="tab-btn">Casino</a>
    <a href="{{ url_for('proxy') }}" class="tab-btn">More</a>
</div>

<!-- ========================================
     GAMES TAB
======================================== -->
<div id="gamesTab" class="tab-content active">
    <div class="search-container">
        <input type="text" id="gameSearch" class="search-box" placeholder="Search games..." onkeyup="filterGames()">
    </div>

    <!-- Featured Games Section -->
    <div class="game-section">
        <div class="section-header expanded" onclick="toggleSection('featured')">
            <div class="section-header-left">
                <div>
                    <div class="section-title">Featured Games</div>
                    <div class="section-count">Handpicked favorites based on BG student statistics</div>
                </div>
            </div>
            <div class="section-toggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>
        <div class="games-grid-wrapper show" id="featured-games">
            <div class="games-grid" id="ownGamesGrid">
                {% for game_id, game in games.items() %}
                {% if game.get('is_own_game', False) %}
                <div class="game-card {% if not game.get('available', True) %}unavailable{% endif %}" data-game-name="{{ game.name|lower }}" {% if game.get('background_image') %}style="background-image: linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url('{{ game.background_image }}'); background-size: cover; background-position: center; background-repeat: no-repeat;"{% endif %}>
                    <div class="game-card-header">
                        <h3 class="game-title">{{ game.name }}</h3>
                        {% if not game.get('available', True) %}
                        <span class="game-badge badge-maintenance">Maintenance</span>
                        {% elif game.get('free_for_all', True) %}
                        <span class="game-badge badge-free">Free</span>
                        {% elif session.username in purchases and game_id in purchases[session.username] %}
                        <span class="game-badge badge-owned">Owned</span>
                        {% else %}
                        <span class="game-badge badge-price">{{ game.get('price', 0) }} Tokens</span>
                        {% endif %}
                    </div>
                    <div class="game-card-footer">
                        {% if game.get('available', True) %}
                            {% if game.get('free_for_all', True) or (session.username in purchases and game_id in purchases[session.username]) %}
                            <a href="{{ url_for('play_game', game_id=game_id) }}" class="play-btn" target="_blank">{% if game.get('is_minecraft_game', False) %}Download{% else %}Play{% endif %}</a>
                            {% else %}
                            <button class="play-btn purchase" onclick="purchaseGame('{{ game_id }}', {{ game.get('price', 0) }})">Purchase</button>
                            {% endif %}
                        {% else %}
                        <button class="play-btn disabled">Unavailable</button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Roblox Games Section -->
    <div class="game-section">
        <div class="section-header expanded" onclick="toggleSection('roblox')">
            <div class="section-header-left">
                <div>
                    <div class="section-title">Roblox √ó StudyHall</div>
                    <div class="section-count">Roblox experiences</div>
                </div>
            </div>
            <div class="section-toggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>
        <div class="games-grid-wrapper show"id="roblox-games">
<div class="games-grid" id="robloxGamesGrid">
{% for game_id, game in games.items() %}
{% if game.get('is_roblox_game', False) %}
<div class="game-card {% if not game.get('available', True) %}unavailable{% endif %}" data-game-name="{{ game.name|lower }}" {% if game.get('background_image') %}style="background-image: linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url('{{ game.background_image }}'); background-size: cover; background-position: center; background-repeat: no-repeat;"{% endif %}>
<div class="game-card-header">
<h3 class="game-title">{{ game.name }}</h3>
{% if not game.get('available', True) %}
<span class="game-badge badge-maintenance">Maintenance</span>
{% elif game.get('free_for_all', True) %}
<span class="game-badge badge-free">Free</span>
{% elif session.username in purchases and game_id in purchases[session.username] %}
<span class="game-badge badge-owned">Owned</span>
{% else %}
<span class="game-badge badge-price">{{ game.get('price', 0) }} Tokens</span>
{% endif %}
</div>
<div class="game-card-footer">
{% if game.get('available', True) %}
{% if game.get('free_for_all', True) or (session.username in purchases and game_id in purchases[session.username]) %}
<a href="{{ url_for('play_game', game_id=game_id) }}" class="play-btn" target="_blank">Play</a>
{% else %}
<button class="play-btn purchase" onclick="purchaseGame('{{ game_id }}', {{ game.get('price', 0) }})">Purchase</button>
{% endif %}
{% else %}
<button class="play-btn disabled">Unavailable</button>
{% endif %}
</div>
</div>
{% endif %}
{% endfor %}
</div>
</div>
</div><!-- Minecraft Games Section -->
    <div class="game-section">
        <div class="section-header expanded" onclick="toggleSection('minecraft')">
            <div class="section-header-left">
                <div>
                    <div class="section-title">Minecraft</div>
                    <div class="section-count">Contact the Admin if you want to join public Serves</div>
                </div>
            </div>
            <div class="section-toggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>
        <div class="games-grid-wrapper show" id="minecraft-games">
            <div class="games-grid" id="minecraftGamesGrid">
                {% for game_id, game in games.items() %}
                {% if game.get('is_minecraft_game', False) %}
                <div class="game-card {% if not game.get('available', True) %}unavailable{% endif %}" data-game-name="{{ game.name|lower }}" {% if game.get('background_image') %}style="background-image: linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url('{{ game.background_image }}'); background-size: cover; background-position: center; background-repeat: no-repeat;"{% endif %}>
                    <div class="game-card-header">
                        <h3 class="game-title">{{ game.name }}</h3>
                        {% if not game.get('available', True) %}
                        <span class="game-badge badge-maintenance">Maintenance</span>
                        {% elif game.get('free_for_all', True) %}
                        <span class="game-badge badge-free">Free</span>
                        {% elif session.username in purchases and game_id in purchases[session.username] %}
                        <span class="game-badge badge-owned">Owned</span>
                        {% else %}
                        <span class="game-badge badge-price">{{ game.get('price', 0) }} Tokens</span>
                        {% endif %}
                    </div>
                    <div class="game-card-footer">
                        {% if game.get('available', True) %}
                            {% if game.get('free_for_all', True) or (session.username in purchases and game_id in purchases[session.username]) %}
                            <a href="{{ url_for('play_game', game_id=game_id) }}" class="play-btn" target="_blank">Download</a>
                            {% else %}
                            <button class="play-btn purchase" onclick="purchaseGame('{{ game_id }}', {{ game.get('price', 0) }})">Purchase</button>
                            {% endif %}
                        {% else %}
                        <button class="play-btn disabled">Unavailable</button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Pok√©mon Games Section -->
    <div class="game-section">
        <div class="section-header expanded" onclick="toggleSection('pokemon')">
            <div class="section-header-left">
                <div>
                    <div class="section-title">Pok√©mon Games</div>
                    <div class="section-count">Pokemon Games suggestion originated from Ben</div>
                </div>
            </div>
            <div class="section-toggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>
        <div class="games-grid-wrapper show" id="pokemon-games">
            <div class="games-grid" id="pokemonGamesGrid">
                {% for game_id, game in games.items() %}
                {% if game.get('is_pokemon_game', False) %}
                <div class="game-card {% if not game.get('available', True) %}unavailable{% endif %}" data-game-name="{{ game.name|lower }}" {% if game.get('background_image') %}style="background-image: linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url('{{ game.background_image }}'); background-size: cover; background-position: center; background-repeat: no-repeat;"{% endif %}>
                    <div class="game-card-header">
                        <h3 class="game-title">{{ game.name }}</h3>
                        {% if not game.get('available', True) %}
                        <span class="game-badge badge-maintenance">Maintenance</span>
                        {% elif game.get('free_for_all', True) %}
                        <span class="game-badge badge-free">Free</span>
                        {% elif session.username in purchases and game_id in purchases[session.username] %}
                        <span class="game-badge badge-owned">Owned</span>
                        {% else %}
                        <span class="game-badge badge-price">{{ game.get('price', 0) }} Tokens</span>
                        {% endif %}
                    </div>
                    <div class="game-card-footer">
                        {% if game.get('available', True) %}
                            {% if game.get('free_for_all', True) or (session.username in purchases and game_id in purchases[session.username]) %}
                            <a href="{{ url_for('play_game', game_id=game_id) }}" class="play-btn" target="_blank">Play</a>
                            {% else %}
                            <button class="play-btn purchase" onclick="purchaseGame('{{ game_id }}', {{ game.get('price', 0) }})">Purchase</button>
                            {% endif %}
                        {% else %}
                        <button class="play-btn disabled">Unavailable</button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- All Games Section -->
    <div class="game-section">
        <div class="section-header expanded" onclick="toggleSection('all')">
            <div class="section-header-left">
                <div>
                    <div class="section-title">All Games</div>
                    <div class="section-count">Everything else</div>
                </div>
            </div>
            <div class="section-toggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>
        <div class="games-grid-wrapper show" id="all-games">
            <div class="games-grid" id="normalGamesGrid">
                {% for game_id, game in games.items() %}
                {% if not game.get('is_own_game', False) and not game.get('is_roblox_game', False) and not game.get('is_minecraft_game', False) and not game.get('is_pokemon_game', False) %}
                <div class="game-card {% if not game.get('available', True) %}unavailable{% endif %}" data-game-name="{{ game.name|lower }}" {% if game.get('background_image') %}style="background-image: linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url('{{ game.background_image }}'); background-size: cover; background-position: center; background-repeat: no-repeat;"{% endif %}>
                    <div class="game-card-header">
                        <h3 class="game-title">{{ game.name }}</h3>
                        {% if not game.get('available', True) %}
                        <span class="game-badge badge-maintenance">Maintenance</span>
                        {% elif game.get('free_for_all', True) %}
                        <span class="game-badge badge-free">Free</span>
                        {% elif session.username in purchases and game_id in purchases[session.username] %}
                        <span class="game-badge badge-owned">Owned</span>
                        {% else %}
                        <span class="game-badge badge-price">{{ game.get('price', 0) }} Tokens</span>
                        {% endif %}
                    </div>
                    <div class="game-card-footer">
                        {% if game.get('available', True) %}
                            {% if game.get('free_for_all', True) or (session.username in purchases and game_id in purchases[session.username]) %}
                            <a href="{{ url_for('play_game', game_id=game_id) }}" class="play-btn" target="_blank">Play</a>
                            {% else %}
                            <button class="play-btn purchase" onclick="purchaseGame('{{ game_id }}', {{ game.get('price', 0) }})">Purchase</button>
                            {% endif %}
                        {% else %}
                        <button class="play-btn disabled">Unavailable</button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- ========================================
     TOKENS TAB
======================================== -->
<div id="tokensTab" class="tab-content">
    <!-- Advent Calendar -->
    <div class="tokens-content">
        <h2>üéÑ Advent Calendar 2025</h2>
        <p class="subtitle">Open a door each day to claim your reward!</p>

        <div class="advent-message" id="adventMessage"></div>

        <div class="advent-calendar-container">
            <div class="advent-tree" id="adventTree">
                <!-- Tree will be built by JavaScript -->
            </div>
        </div>

        <div class="balance-display"><span id="balance">{{ users[session.username]['tokens'] }}</span> üéüÔ∏è</div>
    </div>

    <!-- Rank Pass -->
    <div class="tokens-content">
        <h2>Rank Pass</h2>
        <p class="subtitle">Daily bonus rewards for ranked members</p>

        <div id="rankPassMessage"></div>

        {% set user_rank = users[session.username].get('rank') %}
        {% if user_rank %}
        <div id="rankContainer" class="rank-container">
            <div class="rank-grid">
                {% set rank_rewards = [
                    {'id': 'bronze', 'name': 'Bronze', 'tokens': 5, 'color': '#CD7F32', 'icon': 'ü•â'},
                    {'id': 'silver', 'name': 'Silver', 'tokens': 10, 'color': '#C0C0C0', 'icon': 'ü•à'},
                    {'id': 'vip', 'name': 'VIP', 'tokens': 20, 'color': '#FFD700', 'icon': 'üíé'},
                    {'id': 'platinum', 'name': 'Platinum', 'tokens': 25, 'color': '#E5E4E2', 'icon': '‚≠ê'},
                    {'id': 'elite', 'name': 'Elite', 'tokens': 30, 'color': '#9966CC', 'icon': 'üëë'},
                    {'id': 'grandmaster', 'name': 'Grandmaster', 'tokens': 67, 'color': '#FF4500', 'icon': 'üèÜ'},
                    {'id': 'minister', 'name': 'Minister', 'tokens': 100, 'color': '#FF0000', 'icon': 'üî±'}
                ] %}

                {% for rank in rank_rewards %}
                <div class="rank-card {% if rank.id == user_rank %}active{% endif %}">
                    <div class="rank-card-icon">{{ rank.icon }}</div>
                    <div class="rank-card-name">{{ rank.name }}</div>
                    <div class="rank-card-tokens">üéüÔ∏è {{ rank.tokens }}</div>
                </div>
                {% endfor %}
            </div>

            <button id="claimRankPassBtn" class="rank-claim-btn" onclick="claimRankPass()">
                Claim Daily Reward
            </button>
        </div>
        {% else %}
        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;">üîí</div>
            <p>Purchase a rank in the Shop to unlock daily rewards</p>
        </div>
        {% endif %}
    </div>

    <!-- Leaderboard -->
    <div class="leaderboard-container">
        <h3>Leaderboard</h3>
        <div class="leaderboard-list" id="leaderboard">
            <p style="text-align: center; color: var(--text-muted);">Loading...</p>
        </div>
    </div>

    <!-- Code Redemption -->
    <div class="code-container">
        <h3>Redeem Code</h3>
        <div class="code-input-group">
            <input type="text" id="codeInput" placeholder="Enter code...">
            <button class="btn btn-primary" onclick="redeemCode()">Redeem</button>
        </div>
        <div id="codeMessage"></div>
    </div>
</div>

<!-- ========================================
     SHOP TAB
======================================== -->
<div id="shopTab" class="tab-content">
    <div class="shop-container">
        <h2>Token Shop</h2>

        <div class="shop-section">
            <h3>Ranks</h3>
            <p>Upgrade your rank for exclusive perks. Purchase in order.</p>

            {% set current_rank = users[session.username].get('rank') %}

            <div class="rank-shop-list">
                {% for rank in RANKS %}
                <div class="rank-shop-item {% if loop.index0 > current_rank_index + 1 %}locked{% endif %}">
                    <div class="rank-shop-info">
                        <div class="rank-shop-name" style="color: {{ rank.color }};">
                            {{ rank.name }}
                            {% if rank['id'] == current_rank %}
                            <span style="background: {{ rank.color }}; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.65rem; margin-left: 0.4rem;">CURRENT</span>
                            {% endif %}
                        </div>
                        <div class="rank-shop-price">üéüÔ∏è {{ rank.price }} Tokens</div>
                    </div>
                    <div class="rank-shop-actions">
                        <button class="btn" onclick="showRankInfo('{{ rank['id'] }}', '{{ rank.name }}', '{{ rank.color }}')">Info</button>
                        {% if rank['id'] == current_rank %}
                        <button class="btn" disabled>Current</button>
                        {% elif loop.index0 < current_rank_index %}
                        <button class="btn" disabled>Owned</button>
                        {% elif loop.index0 == current_rank_index + 1 %}
                        <button class="btn btn-primary" onclick="purchaseRank('{{ rank['id'] }}', {{ rank.price }}, '{{ rank.name }}')">Purchase</button>
                        {% else %}
                        <button class="btn" disabled>üîí Locked</button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div style="text-align: center; color: var(--text-muted); padding: 1.5rem;">
            <p>More items coming soon...</p>
        </div>
    </div>
</div>

<!-- ========================================
     FEEDBACK SECTION
======================================== -->
<div class="feedback-section">
    <h3>Submit Suggestions</h3>
    <form method="POST" action="{{ url_for('submit_feedback') }}">
        <textarea name="feedback" class="feedback-textarea" placeholder="Share suggestions, feedback, or report bugs..." required></textarea>
        <button type="submit" class="btn btn-primary">Submit Feedback</button>
    </form>
</div></div>
<!-- ========================================
     MODALS
======================================== -->
<!-- Lunch Menu Modal -->
<div id="lunchModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Today's Lunch</h2>
            <button onclick="closeLunchModal()" class="modal-close">√ó</button>
        </div>
        <div id="lunchMenuContent">
            <p style="text-align: center; color: var(--text-muted);">Loading...</p>
        </div>
    </div>
</div>
<!-- Rank Info Modal -->
<div id="rankInfoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="rankInfoTitle">Rank Info</h2>
            <button onclick="closeRankInfo()" class="modal-close">√ó</button>
        </div>
        <div id="rankInfoContent" style="line-height: 1.6;">
            <p>Loading...</p>
        </div>
    </div>
</div>

<!-- Game Selection Modal (Door 2) -->
<div id="gameSelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">üéÅ Choose Your Free Game!</h2>
            <button onclick="closeGameSelectModal()" class="modal-close">√ó</button>
        </div>
        <p style="text-align: center; color: var(--christmas-red); font-weight: 800; margin-bottom: 1rem;">
            ‚ö†Ô∏è Choose wisely! You can only pick ONE game. Closing this window forfeits your reward.
        </p>
        <div id="gameSelectGrid" class="game-select-grid">
            <!-- Games will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Chat Notification Container -->
<div id="chatNotificationContainer"></div>
<!-- ========================================
     JAVASCRIPT
======================================== -->
<script>
    // ========================================
    // SECTION TOGGLE
    // ========================================
    function toggleSection(sectionId) {
        const wrapper = document.getElementById(sectionId + '-games');
        const header = wrapper.previousElementSibling;

        wrapper.classList.toggle('show');
        header.classList.toggle('expanded');
    }

    // ========================================
    // MODAL FUNCTIONS
    // ========================================
    function showLunchMenu() {
        const modal = document.getElementById('lunchModal');
        if (modal) {
            modal.style.display = 'flex';

            fetch('/api/lunch_menu')
                .then(response => response.json())
                .then(data => {
                    let html = `<p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">${data.date}</p>`;

                    html += `<div class="lunch-today">
                        <div class="lunch-label">Today's Menu</div>
                        <div class="lunch-food">${data.today.food}</div>`;

                    if (data.today.fact) {
                        html += `<div class="lunch-fact">${data.today.fact}</div>`;
                    }

                    html += `</div>`;

                    if (data.tomorrow) {
                        html += `<div class="lunch-tomorrow">
                            <div class="lunch-label">Tomorrow</div>
                            <div class="lunch-food">${data.tomorrow.food}</div>
                        </div>`;
                    }

                    document.getElementById('lunchMenuContent').innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('lunchMenuContent').innerHTML =
                        '<p style="text-align: center; color: var(--christmas-red);">Error loading menu</p>';
                });
        }
    }

    function closeLunchModal() {
        document.getElementById('lunchModal').style.display = 'none';
    }

    // ========================================
    // TAB SWITCHING
    // ========================================
    function switchTab(tabName, element) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

    document.getElementById(tabName + 'Tab').classList.add('active');
    element.classList.add('active');
}

    // ========================================
    // GAME SEARCH
    // ========================================
    function filterGames() {
        const searchValue = document.getElementById('gameSearch').value.toLowerCase();
        document.querySelectorAll('.game-card').forEach(card => {
            const gameName = card.getAttribute('data-game-name');
            card.style.display = gameName.includes(searchValue) ? 'flex' : 'none';
        });
    }

    // ========================================
    // GAME PURCHASE
    // ========================================
    function purchaseGame(gameId, price) {
        if (confirm(`Purchase this game for ${price} tokens?`)) {
            fetch(`/purchase_game/${gameId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Purchase successful! New balance: ${data.new_balance} tokens`);
                    location.reload();
                } else {
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(error => alert('Error purchasing game'));
        }
    }

    // ========================================
    // ADVENT CALENDAR
    // ========================================
    let adventCalendarData = null;
    let pendingGameSelection = false;

    // Christmas tree layout - number of doors per row
    const treeLayout = [
        [1],           // Top of tree
        [2, 3],        // Row 2
        [4, 5, 6],     // Row 3
        [7, 8, 9, 10], // Row 4
        [11, 12, 13, 14, 15],     // Row 5
        [16, 17, 18, 19, 20, 21], // Row 6
        [22, 23, 24]   // Bottom row (trunk)
    ];

    // Door icons based on state
    const doorIcons = {
        locked: 'üîí',
        available: 'üéÅ',
        opened: '‚ú®',
        missed: '‚ùå'
    };

    async function loadAdventCalendar() {
        try {
            const response = await fetch('/api/advent/status');
            const data = await response.json();

            if (data.success) {
                adventCalendarData = data;
                renderAdventCalendar();
            }
        } catch (error) {
            console.error('Error loading advent calendar:', error);
            showAdventMessage('Error loading calendar', true);
        }
    }

    function renderAdventCalendar() {
        const tree = document.getElementById('adventTree');
        if (!tree || !adventCalendarData) return;

        tree.innerHTML = '';

        treeLayout.forEach(row => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'tree-row';

            row.forEach(doorNum => {
                const doorData = adventCalendarData.doors[doorNum];
                const door = document.createElement('div');
                door.className = `advent-door ${doorData.state}`;
                door.dataset.door = doorNum;

                // Door number
                const numberSpan = document.createElement('span');
                numberSpan.className = 'advent-door-number';
                numberSpan.textContent = doorNum;
                door.appendChild(numberSpan);

                // Door icon
                const icon = document.createTextNode(doorIcons[doorData.state]);
                door.appendChild(icon);

                // Click handler for available doors
                if (doorData.state === 'available') {
                    door.addEventListener('click', () => openAdventDoor(doorNum));
                }

                rowDiv.appendChild(door);
            });

            tree.appendChild(rowDiv);
        });
    }

    async function openAdventDoor(doorNumber) {
        if (pendingGameSelection) {
            showAdventMessage('Please finish selecting your game first!', true);
            return;
        }

        try {
            const response = await fetch(`/api/advent/open/${doorNumber}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                if (data.reward_type === 'tokens') {
                    // Token reward
                    showAdventMessage(`üéâ You received ${data.amount} tokens!`, false);
                    document.getElementById('balance').textContent = data.new_balance;
                    await loadAdventCalendar(); // Reload calendar
                } else if (data.reward_type === 'free_game') {
                    // Free game - show selection modal
                    pendingGameSelection = true;
                    showGameSelectModal(data.available_games);
                } else if (data.reward_type === 'youtube_access') {
                    // YouTube access
                    showAdventMessage(`üéâ ${data.message}`, false);
                    await loadAdventCalendar(); // Reload calendar
                }
            } else {
                showAdventMessage(data.error || 'Could not open door', true);
            }
        } catch (error) {
            console.error('Error opening door:', error);
            showAdventMessage('Error opening door', true);
        }
    }

    function showAdventMessage(text, isError) {
        const messageDiv = document.getElementById('adventMessage');
        if (!messageDiv) return;

        messageDiv.textContent = text;
        messageDiv.className = 'advent-message show';
        if (isError) {
            messageDiv.classList.add('error');
        }

        setTimeout(() => {
            messageDiv.classList.remove('show');
        }, 5000);
    }

    function showGameSelectModal(games) {
        const modal = document.getElementById('gameSelectModal');
        const grid = document.getElementById('gameSelectGrid');

        if (!modal || !grid) return;

        // Clear grid
        grid.innerHTML = '';

        if (games.length === 0) {
            grid.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No games available!</p>';
        } else {
            games.forEach(game => {
                const card = document.createElement('div');
                card.className = 'game-select-card';
                card.innerHTML = `
                    <h4>${game.name}</h4>
                    <div class="game-price">Worth: üéüÔ∏è ${game.price} tokens</div>
                `;
                card.addEventListener('click', () => selectFreeGame(game.id, game.name));
                grid.appendChild(card);
            });
        }

        modal.style.display = 'flex';
    }

    async function selectFreeGame(gameId, gameName) {
        if (!confirm(`Select "${gameName}" as your free game? This cannot be undone!`)) {
            return;
        }

        try {
            const response = await fetch('/api/advent/claim_game', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ game_id: gameId })
            });
            const data = await response.json();

            if (data.success) {
                closeGameSelectModal();
                showAdventMessage(`üéâ You claimed ${data.game_name}!`, false);
                pendingGameSelection = false;
                await loadAdventCalendar(); // Reload calendar
            } else {
                alert(data.error || 'Error claiming game');
            }
        } catch (error) {
            console.error('Error claiming game:', error);
            alert('Error claiming game');
        }
    }

    function closeGameSelectModal() {
        const modal = document.getElementById('gameSelectModal');
        if (modal) {
            modal.style.display = 'none';
            // If they close without selecting, they lose the opportunity
            if (pendingGameSelection) {
                showAdventMessage('You forfeited your free game selection!', true);
                pendingGameSelection = false;
                loadAdventCalendar(); // Reload to show door as opened without reward
            }
        }
    }

    // Load advent calendar on page load
    loadAdventCalendar();

    // ========================================
    // RANK PASS
    // ========================================
    async function claimRankPass() {
        const btn = document.getElementById('claimRankPassBtn');
        const message = document.getElementById('rankPassMessage');
        const rankCards = document.querySelectorAll('.rank-card');

        btn.disabled = true;

        try {
            const response = await fetch('/api/claim_rank_pass', { method: 'POST' });
            const data = await response.json();

            if (data.success) {
                message.textContent = `‚úì Claimed +${data.reward} tokens`;
                message.style.color = '#22c55e';
                rankCards.forEach(card => card.classList.add('claimed'));
                btn.textContent = 'Already Claimed';
                document.getElementById('balance').textContent = data.new_balance;
                updateLeaderboard();
            } else {
                message.textContent = data.error || 'Already claimed today';
                message.style.color = '#ff6b6b';
                if (data.claimed_today) {
                    rankCards.forEach(card => card.classList.add('claimed'));
                    btn.textContent = 'Already Claimed';
                }
            }
        } catch (error) {
            message.textContent = 'Error claiming reward';
            message.style.color = '#ff6b6b';
            btn.disabled = false;
        }
    }

    async function checkRankPassStatus() {
        try {
            const response = await fetch('/api/rank_pass_status');
            const data = await response.json();
            const btn = document.getElementById('claimRankPassBtn');
            const message = document.getElementById('rankPassMessage');
            const rankCards = document.querySelectorAll('.rank-card');

            if (btn && data.claimed_today) {
                message.textContent = 'Come back tomorrow for your next reward';
                message.style.color = '#888';
                rankCards.forEach(card => card.classList.add('claimed'));
                btn.disabled = true;
                btn.textContent = 'Already Claimed';
            }
        } catch (error) {
            console.error('Error checking rank pass status:', error);
        }
    }

    checkRankPassStatus();

    // ========================================
    // LEADERBOARD
    // ========================================
    function updateLeaderboard() {
        fetch('/api/leaderboard')
            .then(response => response.json())
            .then(data => {
                const leaderboard = document.getElementById('leaderboard');
                if (data.leaderboard.length === 0) {
                    leaderboard.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No players yet</p>';
                    return;
                }
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                let html = '';

                data.leaderboard.forEach(player => {
                    const medal = medals[player.rank - 1] || `#${player.rank}`;
                    html += `
                        <div class="leaderboard-item">
                            <span class="leaderboard-rank">${medal}</span>
                            <span class="leaderboard-name">${player.username}</span>
                            <span class="leaderboard-tokens">üéüÔ∏è ${player.tokens}</span>
                        </div>
                    `;
                });

                leaderboard.innerHTML = html;
            })
            .catch(error => console.error('Error loading leaderboard:', error));
    }

    updateLeaderboard();
    setInterval(updateLeaderboard, 10000);

    // ========================================
    // CODE REDEMPTION
    // ========================================
    function redeemCode() {
        const code = document.getElementById('codeInput').value.trim();
        const messageDiv = document.getElementById('codeMessage');

        if (!code) {
            messageDiv.className = 'error';
            messageDiv.textContent = 'Please enter a code';
            messageDiv.style.display = 'block';
            return;
        }

        fetch('/api/redeem_code/' + code, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageDiv.className = 'success';
                messageDiv.textContent = `üéâ +${data.tokens} tokens! Balance: ${data.new_balance}`;
                document.getElementById('codeInput').value = '';
                document.getElementById('balance').textContent = data.new_balance;
            } else {
                messageDiv.className = 'error';
                messageDiv.textContent = data.error;
            }
            messageDiv.style.display = 'block';
            setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
        })
        .catch(error => {
            messageDiv.className = 'error';
            messageDiv.textContent = 'Error redeeming code';
            messageDiv.style.display = 'block';
});
}// ========================================
// RANK PURCHASE & INFO
// ========================================
function purchaseRank(rankId, price, rankName) {
    if (confirm(`Purchase ${rankName} rank for ${price} tokens?`)) {
        fetch('/purchase_rank/' + rankId, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Success! You are now ${data.rank}!`);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => alert('Error purchasing rank'));
    }
}

const rankInfoData = {
    'bronze': {
        description: 'Bronze rank is the first step on your journey!',
        perks: ['Separate display in Chat', '5 daily tokens from Rank Pass']
    },
    'silver': {
        description: 'Silver rank shows you are committed to climbing!',
        perks: ['All previous perks', '10 daily tokens from Rank Pass', 'Early update sneakpeaks']
    },
    'vip': {
        description: 'VIP status - you are a very special person!',
        perks: ['All previous perks', '20 daily tokens from Rank Pass']
    },
    'platinum': {
        description: 'Platinum rank - Reserved for the dedicated few.',
        perks: ['All previous perks', 'Priority suggestions', 'Cannot be banned by Ambassadors', '25 daily tokens']
    },
    'elite': {
        description: 'Elite rank - The pinnacle of prestige.',
        perks: ['All previous perks', '30 daily tokens from Rank Pass']
    },
    'grandmaster': {
        description: 'Grandmaster - legendary status!',
        perks: ['All previous perks', 'All games included', '67 daily tokens from Rank Pass']
    },
    'minister': {
        description: 'Minister - the ultimate rank.',
        perks: ['All previous perks', 'Create promo codes', '100 daily tokens from Rank Pass']
    }
};

function showRankInfo(rankId, rankName, rankColor) {
    const modal = document.getElementById('rankInfoModal');
    const title = document.getElementById('rankInfoTitle');
    const content = document.getElementById('rankInfoContent');
    const info = rankInfoData[rankId];

    title.textContent = rankName + ' Rank';
    title.style.color = rankColor;

    let html = `<p style="margin-bottom: 1rem; color: var(--text-medium);">${info.description}</p>`;
    html += `<h4 style="margin-bottom: 0.75rem; color: ${rankColor}; font-family: 'Fredoka One', cursive;">Perks</h4><ul style="list-style: none; padding: 0;">`;
    info.perks.forEach(perk => {
        html += `<li style="padding: 0.5rem 0.75rem; background: var(--christmas-snow); border-left: 3px solid ${rankColor}; margin-bottom: 0.4rem; border-radius: 4px;">‚úì ${perk}</li>`;
    });
    html += '</ul>';

    content.innerHTML = html;
    modal.style.display = 'flex';
}

function closeRankInfo() {
    document.getElementById('rankInfoModal').style.display = 'none';
}

document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
});

// ========================================
// CHAT NOTIFICATIONS
// ========================================
let shownNotifications = new Set();
let lastNotificationCheck = '';

function checkChatNotifications() {
    fetch(window.location.origin + '/api/chat_notifications')
        .then(response => response.json())
        .then(data => {
            data.notifications.forEach(notif => {
                const notifKey = `${notif.from}-${notif.timestamp}`;
                if (!shownNotifications.has(notifKey) && notif.timestamp > lastNotificationCheck) {
                    showChatNotification(notif.from, notif.type || 'message');
                    shownNotifications.add(notifKey);
                }
            });
            if (data.notifications.length > 0) {
                lastNotificationCheck = data.notifications[0].timestamp;
            }
        })
        .catch(error => console.error('Error checking notifications:', error));
}

function showChatNotification(fromUser, type = 'message') {
    const container = document.getElementById('chatNotificationContainer');
    if (!container) return;

    let title, icon, action;
    if (type === 'rps_invite') {
        title = 'RPS Challenge!';
        icon = '‚úÇÔ∏è';
        action = 'challenged you to Rock Paper Scissors';
    } else {
        title = 'New Message';
        icon = 'üí¨';
        action = 'sent you a message';
    }

    const notification = document.createElement('div');
    notification.className = 'chat-notification';
    notification.innerHTML = `
        <div class="notification-header">
            <div class="notification-icon">${icon}</div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-user">${fromUser}</div>
                <div class="notification-action">${action}</div>
            </div>
            <button class="notification-close" onclick="event.stopPropagation(); closeNotification(this.parentElement.parentElement)">‚úï</button>
        </div>
    `;

    notification.addEventListener('click', () => {
        window.location.href = `/chat/${fromUser}`;
    });

    container.appendChild(notification);
    setTimeout(() => closeNotification(notification), 5000);
}

function closeNotification(notification) {
    notification.classList.add('hiding');
    setTimeout(() => notification.remove(), 300);
}

setInterval(checkChatNotifications, 2000);
checkChatNotifications();

</script>
</body>
</html>