<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #4b1e00 0%, #ff6f1f 40%, #ff914d 100%);
            background-attachment: fixed;
            color: #1a1a1a;
            padding: 2rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 247, 235, 0.98);
            padding: 2.5rem;
            border-radius: 40px;
            border: 8px solid #2C2C2C;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 900;
            color: #2C2C2C;
            text-transform: uppercase;
        }

        .role-badge {
            display: inline-block;
            background: linear-gradient(135deg, #c19a6b 0%, #d4af7a 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 900;
            text-transform: uppercase;
            border: 3px solid #2C2C2C;
            box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            background: white;
            border: 4px solid #2C2C2C;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            color: #2C2C2C;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 700;
            transition: all 0.3s;
            box-shadow: 0 4px 0 #2C2C2C;
            text-transform: uppercase;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #2C2C2C;
        }

        .nav-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #2C2C2C;
        }

        /* Search Bar */
        .search-container {
            margin-bottom: 2rem;
            background: white;
            border: 5px solid #2C2C2C;
            border-radius: 24px;
            padding: 1.5rem;
            box-shadow: 0 8px 0 rgba(44, 44, 44, 0.3);
        }

        .search-input {
            width: 100%;
            padding: 1rem;
            border: 4px solid #2C2C2C;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);
        }

        .search-input:focus {
            outline: none;
            border-color: #c19a6b;
        }

        /* Collapsible Sections */
        .section {
            background: #ffffff;
            border: 5px solid #2C2C2C;
            border-radius: 24px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 0 rgba(44, 44, 44, 0.3);
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #fffbf5 0%, #f5f5f5 100%);
            cursor: pointer;
            user-select: none;
            border-bottom: 5px solid #2C2C2C;
        }

        .section-header:hover {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        }

        .section-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #2C2C2C;
            font-weight: 900;
            text-transform: uppercase;
        }

        .section-toggle {
            font-size: 1.5rem;
            font-weight: 900;
            color: #c19a6b;
            transition: transform 0.3s;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 2rem;
            display: none;
        }

        .section-content.active {
            display: block;
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #2C2C2C;
            font-weight: 900;
            text-transform: uppercase;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 700;
            color: #2d2d2d;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="file"],
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 4px solid #2C2C2C;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            font-weight: 600;
            box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);
        }

        textarea {
            min-height: 150px;
            resize: vertical;
        }

        button, .btn {
            background: linear-gradient(135deg, #c19a6b 0%, #d4af7a 100%);
            color: white;
            border: 4px solid #2C2C2C;
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 700;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 4px 0 #2C2C2C;
            text-transform: uppercase;
        }

        button:hover, .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #2C2C2C;
        }

        button:active, .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #2C2C2C;
        }

        .btn-danger {
            background: linear-gradient(135deg, #c00 0%, #a00 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #e68900 100%);
        }

        .user-list, .game-list, .announcement-list {
            margin-top: 1.5rem;
        }

        .user-item, .game-item, .announcement-item {
            background: linear-gradient(135deg, #fffbf5 0%, #f5f5f5 100%);
            border: 4px solid #2C2C2C;
            padding: 1rem;
            border-radius: 16px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 0 rgba(44, 44, 44, 0.3);
        }

        .user-info, .game-info, .announcement-info {
            flex: 1;
        }

        .user-name, .game-name {
            font-weight: 900;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }

        .user-status, .announcement-time {
            font-size: 0.85rem;
            color: #666;
            font-weight: 600;
        }

        .banned-badge {
            background: linear-gradient(135deg, #fee 0%, #fcc 100%);
            color: #c00;
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
            border: 2px solid #c00;
            font-weight: 700;
        }

        .ambassador-badge {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1976d2;
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
            border: 2px solid #1976d2;
            font-weight: 700;
        }

        .unavailable-badge {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #ff9800;
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
            border: 2px solid #ff9800;
            font-weight: 700;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .no-access {
            text-align: center;
            color: #999;
            padding: 2rem;
            font-style: italic;
        }

        .feedback-item {
            background: linear-gradient(135deg, #fffbf5 0%, #f5f5f5 100%);
            border: 4px solid #2C2C2C;
            padding: 1rem;
            border-radius: 16px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            box-shadow: 0 4px 0 rgba(44, 44, 44, 0.3);
        }

        .feedback-content {
            flex: 1;
        }

        .feedback-header {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .feedback-username {
            font-weight: 700;
            color: #c19a6b;
        }

        .feedback-text {
            color: #2d2d2d;
            margin-bottom: 0.25rem;
            line-height: 1.5;
            font-weight: 600;
        }

        .feedback-time {
            font-size: 0.8rem;
            color: #999;
            font-weight: 600;
        }

        /* Login Notifications */
        .notification-badge {
            position: relative;
            display: inline-block;
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 900;
            border: 3px solid #2C2C2C;
            box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);
            margin-left: 1rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .login-notification-item {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 4px solid #ff9800;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 0 rgba(255, 152, 0, 0.3);
        }

        .login-notification-item .username {
            font-weight: 900;
            color: #ff9800;
            font-size: 1.1rem;
        }

        .login-notification-item .time {
            font-size: 0.85rem;
            color: #666;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Admin Panel <span class="role-badge">{{ user_role }}</span></h1>
            <div class="nav-links">
                <a href="{{ url_for('index') }}" class="nav-btn">View Portal</a>
                <a href="{{ url_for('logout') }}" class="nav-btn">Logout</a>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="search-container">
            <input type="text" id="adminSearch" class="search-input" placeholder="üîç Search sections, users, games..." onkeyup="searchSections()">
        </div>

        <!-- Login Notifications -->
        {% if login_notifications %}
        <div class="section">
            <div class="section-header">
                <h2>üîî Login Notifications <span class="notification-badge">{{ login_notifications|length }} New</span></h2>
                <span class="section-toggle collapsed">‚ñº</span>
            </div>
            <div class="section-content">
                {% for notification in login_notifications %}
                <div class="login-notification-item">
                    <div>
                        <div class="username">{{ notification.username }} logged in</div>
                        <div class="time">{{ notification.timestamp }}</div>
                    </div>
                </div>
                {% endfor %}
                <button onclick="clearLoginNotifications()" class="btn" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); width: 100%; margin-top: 1rem;">‚úì Mark All as Read</button>
            </div>
        </div>
        {% endif %}

        <!-- Create User -->
        <div class="section">
            <div class="section-header">
                <h2>Create User Account</h2>
                <span class="section-toggle collapsed">‚ñº</span>
            </div>
            <div class="section-content">
                <form method="POST" action="{{ url_for('create_user') }}">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit">Create User</button>
                </form>
            </div>
        </div>

        <!-- User Management -->
<div class="section">
    <div class="section-header">
        <h2>User Management</h2>
        <span class="section-toggle collapsed">‚ñº</span>
    </div>
    <div class="section-content">
        <div class="user-list">
            {% for username, user in users.items() %}
            {% if username != 'admin' %}
            <div class="user-item" style="display: block; padding: 1.5rem;">
                <!-- User Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 4px solid #2C2C2C;">
                    <div>
                        <div class="user-name" style="font-size: 1.3rem; margin-bottom: 0.5rem;">
                            {{ username }}
                            {% if user.role == 'ambassador' %}
                            <span class="ambassador-badge">AMBASSADOR</span>
                            {% endif %}
                            {% if user.banned %}
                            <span class="banned-badge">BANNED</span>
                            {% endif %}
                        </div>
                        <div style="color: #666; font-size: 0.9rem; font-weight: 600;">
                            Balance: <strong style="color: #c19a6b;">{{ user.tokens }} tokens</strong>
                            {% if user.get('rank') %}
                            ‚Ä¢ Rank: <strong>{{ user.rank|title }}</strong>
                            {% endif %}
                        </div>
                        {% if user.banned %}
                        <div class="user-status" style="margin-top: 0.5rem;">Ban Reason: {{ user.ban_reason }}</div>
                        {% endif %}
                    </div>
                    {% if user_role == 'admin' %}
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="showUserChats('{{ username }}')" class="btn action-btn" style="background: linear-gradient(135deg, #2196F3 0%, #1976d2 100%); border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">üì± View Chats</button>
                        <a href="{{ url_for('delete_user', username=username) }}" class="btn btn-danger action-btn" onclick="return confirm('Delete user {{ username }}?')" style="border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">üóëÔ∏è Delete</a>
                    </div>
                    {% endif %}
                </div>

                <!-- Management Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">

                    <!-- Ambassadors: ONLY see Password and Ban sections -->
                    {% if user_role == 'ambassador' %}

                    <!-- Password Management -->
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 4px solid #2C2C2C; border-left: 8px solid #2196F3; border-radius: 16px; padding: 1rem;">
                        <h4 style="margin-bottom: 0.75rem; color: #2196F3; font-weight: 900; text-transform: uppercase; font-size: 0.9rem;">üîê Password</h4>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="password" id="password-{{ username }}" placeholder="New password" style="flex: 1; padding: 0.75rem; border: 4px solid #2C2C2C; border-radius: 12px; font-weight: 600; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                            <button onclick="submitPasswordForm('{{ username }}')" class="btn action-btn" style="background: linear-gradient(135deg, #2196F3 0%, #1976d2 100%); border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C; padding: 0.75rem 1rem; margin: 0;">Set</button>
                        </div>
                        <form method="POST" action="{{ url_for('change_password', username=username) }}" style="display: none;" id="password-form-{{ username }}">
                            <input type="hidden" name="new_password" id="new-password-{{ username }}">
                        </form>
                    </div>

                    <!-- Ban Management -->
                    <div style="background: linear-gradient(135deg, {% if user.banned %}#ffebee{% else %}#f1f8f5{% endif %} 0%, {% if user.banned %}#ffcdd2{% else %}#c8e6c9{% endif %} 100%); border: 4px solid #2C2C2C; border-left: 8px solid {% if user.banned %}#c00{% else %}#4caf50{% endif %}; border-radius: 16px; padding: 1rem;">
                        <h4 style="margin-bottom: 0.75rem; color: {% if user.banned %}#c00{% else %}#4caf50{% endif %}; font-weight: 900; text-transform: uppercase; font-size: 0.9rem;">‚ö†Ô∏è Moderation</h4>
                        {% if not user.banned %}
                        <form method="POST" action="{{ url_for('ban_user') }}">
                            <input type="hidden" name="username" value="{{ username }}">
                            <input type="text" name="reason" placeholder="Ban reason" style="width: 100%; padding: 0.75rem; border: 4px solid #2C2C2C; border-radius: 12px; margin-bottom: 0.5rem; font-weight: 600; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                            <button type="submit" class="btn btn-danger action-btn" style="width: 100%; border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">üö´ Ban User</button>
                        </form>
                        {% else %}
                        <a href="{{ url_for('unban_user', username=username) }}" class="btn btn-success action-btn" style="width: 100%; border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">‚úÖ Unban User</a>
                        {% endif %}
                    </div>

                    {% endif %}

                    <!-- Admins: See EVERYTHING -->
                    {% if user_role == 'admin' %}

                    <!-- Tokens Management -->
                    <div style="background: linear-gradient(135deg, #fffbf5 0%, #f5f5f5 100%); border: 4px solid #2C2C2C; border-left: 8px solid #c19a6b; border-radius: 16px; padding: 1rem;">
                        <h4 style="margin-bottom: 0.75rem; color: #c19a6b; font-weight: 900; text-transform: uppercase; font-size: 0.9rem;">üí∞ Token Management</h4>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="number" id="token-input-{{ username }}" value="{{ user.tokens }}" style="flex: 1; padding: 0.75rem; border: 4px solid #2C2C2C; border-radius: 12px; font-weight: 600; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                            <button onclick="submitTokenForm('{{ username }}')" class="btn btn-success action-btn" style="border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C; padding: 0.75rem 1rem; margin: 0;">Set</button>
                        </div>
                    </div>

                    <!-- Password Management -->
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 4px solid #2C2C2C; border-left: 8px solid #2196F3; border-radius: 16px; padding: 1rem;">
                        <h4 style="margin-bottom: 0.75rem; color: #2196F3; font-weight: 900; text-transform: uppercase; font-size: 0.9rem;">üîê Password</h4>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="password" id="password-{{ username }}" placeholder="New password" style="flex: 1; padding: 0.75rem; border: 4px solid #2C2C2C; border-radius: 12px; font-weight: 600; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                            <button onclick="submitPasswordForm('{{ username }}')" class="btn action-btn" style="background: linear-gradient(135deg, #2196F3 0%, #1976d2 100%); border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C; padding: 0.75rem 1rem; margin: 0;">Set</button>
                        </div>
                        <form method="POST" action="{{ url_for('change_password', username=username) }}" style="display: none;" id="password-form-{{ username }}">
                            <input type="hidden" name="new_password" id="new-password-{{ username }}">
                        </form>
                    </div>

                    <!-- Role Management -->
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 4px solid #2C2C2C; border-left: 8px solid #ff9800; border-radius: 16px; padding: 1rem;">
                        <h4 style="margin-bottom: 0.75rem; color: #ff9800; font-weight: 900; text-transform: uppercase; font-size: 0.9rem;">üë§ Role</h4>
                        {% if user.role != 'ambassador' %}
                        <a href="{{ url_for('promote_ambassador', username=username) }}" class="btn btn-success action-btn" style="width: 100%; border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">‚¨ÜÔ∏è Promote to Ambassador</a>
                        {% else %}
                        <a href="{{ url_for('demote_ambassador', username=username) }}" class="btn btn-warning action-btn" style="width: 100%; border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">‚¨áÔ∏è Demote to User</a>
                        {% endif %}
                    </div>

                    <!-- Ban Management -->
                    <div style="background: linear-gradient(135deg, {% if user.banned %}#ffebee{% else %}#f1f8f5{% endif %} 0%, {% if user.banned %}#ffcdd2{% else %}#c8e6c9{% endif %} 100%); border: 4px solid #2C2C2C; border-left: 8px solid {% if user.banned %}#c00{% else %}#4caf50{% endif %}; border-radius: 16px; padding: 1rem;">
                        <h4 style="margin-bottom: 0.75rem; color: {% if user.banned %}#c00{% else %}#4caf50{% endif %}; font-weight: 900; text-transform: uppercase; font-size: 0.9rem;">‚ö†Ô∏è Moderation</h4>
                        {% if not user.banned %}
                        <form method="POST" action="{{ url_for('ban_user') }}">
                            <input type="hidden" name="username" value="{{ username }}">
                            <input type="text" name="reason" placeholder="Ban reason" style="width: 100%; padding: 0.75rem; border: 4px solid #2C2C2C; border-radius: 12px; margin-bottom: 0.5rem; font-weight: 600; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                            <button type="submit" class="btn btn-danger action-btn" style="width: 100%; border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">üö´ Ban User</button>
                        </form>
                        {% else %}
                        <a href="{{ url_for('unban_user', username=username) }}" class="btn btn-success action-btn" style="width: 100%; border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">‚úÖ Unban User</a>
                        {% endif %}
                    </div>

                    <!-- Game Access Management -->
                    <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border: 4px solid #2C2C2C; border-left: 8px solid #9c27b0; border-radius: 16px; padding: 1rem;">
                        <h4 style="margin-bottom: 0.75rem; color: #9c27b0; font-weight: 900; text-transform: uppercase; font-size: 0.9rem;">üéÆ Game Access</h4>
                        <button onclick="showGameAccessModal('{{ username }}')" class="btn action-btn" style="width: 100%; background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">Manage Games</button>
                    </div>

                    {% endif %}

                </div>  <!-- Closes Management Grid -->
            </div>  <!-- Closes user-item -->
            {% endif %}  <!-- Closes username != 'admin' -->
            {% endfor %}
        </div>
    </div>
</div>

<!-- Game Management (Admin Only) -->
{% if user_role == 'admin' %}
<div class="section">
    <div class="section-header">
        <h2>Manage Games</h2>
        <span class="section-toggle collapsed">‚ñº</span>
    </div>
    <div class="section-content">
        <div class="game-list">
            {% for game_id, game in games.items() %}
            <div class="game-item" style="{% if game.get('background_image') %}background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('{{ game.background_image }}'); background-size: cover; background-position: center;{% endif %}">
                <div class="game-info">
                    <div class="game-name" style="{% if game.get('background_image') %}color: white;{% endif %}">
                        {{ game.name }}
                        {% if game.get('is_own_game', False) %}
                        <span style="background: #FFD700; color: #000; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; margin-left: 0.5rem;">‚≠ê FEATURED</span>
                        {% endif %}
                        {% if game.get('is_roblox_game', False) %}
                        <span style="background: #FF0000; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; margin-left: 0.5rem;">üéÆ ROBLOX</span>
                        {% endif %}
                        {% if game.get('is_pokemon_game', False) %}
                        <span style="background: #FFCB05; color: #000; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; margin-left: 0.5rem;">‚ö° POK√âMON</span>
                        {% endif %}
                        {% if game.get('is_minecraft_game', False) %}
                        <span style="background: #00AA00; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; margin-left: 0.5rem;">‚õèÔ∏è MINECRAFT</span>
                        {% endif %}
                        {% if not game.get('available', True) %}
                        <span class="unavailable-badge">UNAVAILABLE</span>
                        {% endif %}
                        {% if not game.get('free_for_all', True) %}
                        <span style="background: #c19a6b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; margin-left: 0.5rem;">üí∞ {{ game.get('price', 0) }} tokens</span>
                        {% else %}
                        <span style="background: #4caf50; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; margin-left: 0.5rem;">FREE</span>
                        {% endif %}
                    </div>
                </div>
                <div class="actions" style="flex-wrap: wrap; gap: 0.5rem;">
                    {% if game.get('available', True) %}
                    <a href="{{ url_for('toggle_game', game_id=game_id) }}" class="btn btn-warning action-btn">Set Unavailable</a>
                    {% else %}
                    <a href="{{ url_for('toggle_game', game_id=game_id) }}" class="btn btn-success action-btn">Set Available</a>
                    {% endif %}
                    <form method="POST" action="{{ url_for('toggle_game_price', game_id=game_id) }}" style="display: inline;">
                        <button type="submit" class="btn action-btn" style="background: #2196F3;">
                            {% if game.get('free_for_all', True) %}Make Paid{% else %}Make Free{% endif %}
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('toggle_game_own', game_id=game_id) }}" style="display: inline;">
                        <button type="submit" class="btn action-btn" style="background: #FFD700; color: #000;">
                            {% if game.get('is_own_game', False) %}Remove from Featured{% else %}Add to Featured{% endif %}
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('toggle_game_roblox', game_id=game_id) }}" style="display: inline;">
                        <button type="submit" class="btn action-btn" style="background: #FF0000;">
                            {% if game.get('is_roblox_game', False) %}Remove from Roblox{% else %}Add to Roblox{% endif %}
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('toggle_game_pokemon', game_id=game_id) }}" style="display: inline;">
                        <button type="submit" class="btn action-btn" style="background: #FFCB05; color: #000;">
                            {% if game.get('is_pokemon_game', False) %}‚ö° Remove from Pok√©mon{% else %}‚ö° Add to Pok√©mon{% endif %}
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('toggle_game_minecraft', game_id=game_id) }}" style="display: inline;">
                        <button type="submit" class="btn action-btn" style="background: #00AA00;">
                            {% if game.get('is_minecraft_game', False) %}Remove from Minecraft{% else %}Add to Minecraft{% endif %}
                        </button>
                    </form>
                    {% if not game.get('free_for_all', True) %}
                    <div style="width: 100%; display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <input type="number" id="price-{{ game_id }}" min="0" value="{{ game.get('price', 0) }}" placeholder="Token price" style="flex: 1; padding: 0.5rem; border: 1px solid #e0e0e0; border-radius: 4px;">
                        <button onclick="updateGamePrice('{{ game_id }}')" class="btn btn-success" style="padding: 0.5rem 1rem;">üí∞ Set Price</button>
                    </div>
                    {% endif %}
                    <div style="width: 100%; display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <input type="text" id="bg-{{ game_id }}" value="{{ game.get('background_image', '') }}" placeholder="Background image URL" style="flex: 1; padding: 0.5rem; border: 1px solid #e0e0e0; border-radius: 4px; {% if game.get('background_image') %}color: white; background: rgba(255,255,255,0.1);{% endif %}">
                        <button onclick="updateGameBackground('{{ game_id }}')" class="btn btn-success" style="padding: 0.5rem 1rem;">üñºÔ∏è Set BG</button>
                    </div>
                    <button onclick="showEditGameModal('{{ game_id }}')" class="btn action-btn" style="background: #FF9800;">‚úèÔ∏è Edit Code</button>
                    <a href="{{ url_for('delete_game', game_id=game_id) }}" class="btn btn-danger action-btn" onclick="return confirm('Delete game {{ game.name }}?')">üóëÔ∏è Delete</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="section">
    <div class="section-header">
        <h2>Add New Game</h2>
        <span class="section-toggle collapsed">‚ñº</span>
    </div>
    <div class="section-content">
        <form method="POST" action="{{ url_for('add_game') }}" enctype="multipart/form-data">
            <div class="form-group">
                <label for="game_name">Game Name</label>
                <input type="text" id="game_name" name="game_name" required>
            </div>
            <div class="form-group">
                <label for="price">Token Price</label>
                <input type="number" id="price" name="price" min="0" value="0" required>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="free_for_all" name="free_for_all" checked>
                    Make Free For All
                </label>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="is_own_game" name="is_own_game">
                    Mark as Featured Game
                </label>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="is_roblox_game" name="is_roblox_game">
                    Mark as Roblox Game
                </label>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="is_pokemon_game" name="is_pokemon_game">
                    Mark as Pok√©mon Game
                </label>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="is_minecraft_game" name="is_minecraft_game">
                    Mark as Minecraft Game
                </label>
            </div>
            <div class="form-group">
                <label for="background_image">Background Image URL (optional)</label>
                <input type="text" id="background_image" name="background_image" placeholder="https://example.com/image.jpg">
                <small style="color: #666; font-size: 0.85rem;">Enter a direct image URL for the game card background</small>
            </div>
            <div class="form-group">
                <label>HTML Code</label>
                <div style="margin-bottom: 1rem;">
                    <input type="radio" id="use_textarea" name="html_source" value="textarea" checked onchange="toggleHtmlInput()">
                    <label for="use_textarea" style="display: inline; margin-right: 1rem;">Paste Code</label>
                    <input type="radio" id="use_file" name="html_source" value="file" onchange="toggleHtmlInput()">
                    <label for="use_file" style="display: inline;">Upload File</label>
                </div>
                <textarea id="html_content" name="html_content" style="min-height: 150px;"></textarea>
                <input type="file" id="html_file" name="html_file" accept=".html,.htm" style="display: none;">
                <small style="color: #666; font-size: 0.85rem;">For large files (>1MB), use the upload option</small>
            </div>
            <button type="submit">Add Game</button>
        </form>
    </div>
</div>

        <!-- Create Codes (Admin Only) -->
        <div class="section">
            <div class="section-header">
                <h2>Create Code</h2>
                <span class="section-toggle collapsed">‚ñº</span>
            </div>
            <div class="section-content">
                <form method="POST" action="{{ url_for('create_code') }}" onsubmit="return confirmCodeCreation(event)">
                    <div class="form-group">
                        <label for="code">Code</label>
                        <input type="text" id="code" name="code" placeholder="Enter Code Here" required style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label for="amount">Token Amount (Max 100)</label>
                        <input type="number" id="amount" name="amount" min="1" max="100" required>
                    </div>
                    <button type="submit">Create Code</button>
                </form>

                <h2 style="margin-top: 2rem;">Active Codes</h2>
                <div id="codesList" class="user-list">
                    <p style="text-align: center; color: #999;">Loading codes...</p>
                </div>
            </div>
        </div>

        <!-- Maintenance Mode (Admin Only) -->
        <div class="section">
            <div class="section-header">
                <h2>üöß Maintenance Mode</h2>
                <span class="section-toggle collapsed">‚ñº</span>
            </div>
            <div class="section-content">
                <p style="color: #666; margin-bottom: 1.5rem;">
                    When enabled, only admins and ambassadors can access the website. All other users will see a maintenance page.
                </p>

                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                    <button id="maintenanceToggle" class="btn" style="background: #ff9800;">
                        <span id="maintenanceStatus">Loading...</span>
                    </button>
                    <span id="maintenanceIndicator" style="font-weight: 600;"></span>
                </div>

                <div style="background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 12px; padding: 2rem; margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Maintenance Message</h3>

                    <div class="form-group">
                        <label for="maintenanceTitle">Title</label>
                        <input type="text" id="maintenanceTitle" placeholder="What's Coming" style="width: 100%; padding: 0.75rem; border: 1px solid #e0e0e0; border-radius: 8px;">
                    </div>

                    <div class="form-group">
                        <label>Notes (one per line)</label>
                        <div id="notesContainer" style="margin-bottom: 1rem;">
                            <!-- Notes will be added here -->
                        </div>
                        <button onclick="addNoteField()" class="btn" style="background: #2196F3; padding: 0.5rem 1rem;">+ Add Note</button>
                    </div>

                    <button onclick="saveMaintenanceNotes()" class="btn" style="background: #4caf50; margin-top: 1rem;">Save Message</button>
                </div>
            </div>
        </div>

        <!-- Announcements (Admin Only) -->
        <div class="section">
            <div class="section-header">
                <h2>Announcements</h2>
                <span class="section-toggle collapsed">‚ñº</span>
            </div>
            <div class="section-content">
                <form method="POST" action="{{ url_for('add_announcement') }}">
                    <div class="form-group">
                        <label for="announcement">New Announcement</label>
                        <textarea id="announcement" name="announcement" rows="3" required></textarea>
                    </div>
                    <button type="submit">Post Announcement</button>
                </form>

                <div class="announcement-list">
                    {% for announcement in announcements %}
                    <div class="announcement-item">
                        <div class="announcement-info">
                            <div>{{ announcement.text }}</div>
                            <div class="announcement-time">{{ announcement.timestamp }}</div>
                        </div>
                        <div class="actions">
                            <a href="{{ url_for('delete_announcement', index=loop.index0) }}" class="btn btn-danger action-btn" onclick="return confirm('Delete this announcement?')">Delete</a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Cookie Management (Admin Only) -->
        <div class="section">
            <div class="section-header">
                <h2>ü•† Cookie Management</h2>
                <span class="section-toggle collapsed">‚ñº</span>
            </div>
            <div class="section-content">
                <p style="color: #666; margin-bottom: 1rem;">Reset the fortune cookie to make it claimable again.</p>
                <button onclick="resetCookie()" class="btn" style="background: #ff9800;">Reset Fortune Cookie</button>
            </div>
        </div>

        <!-- Lottery Management (Admin Only) -->
        <div class="section">
            <div class="section-header">
                <h2>üé∞ Lottery Management</h2>
                <span class="section-toggle collapsed">‚ñº</span>
            </div>
            <div class="section-content">
                <div id="lotteryStatus" style="background: #f9f9f9; border: 4px solid #2C2C2C; border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: #FFD700; font-weight: 900;">Current Status</h3>
                    <div id="lotteryStatusContent">
                        <p style="text-align: center; color: #999;">Loading...</p>
                    </div>
                </div>

                <!-- Create Lottery Form -->
                <div id="createLotteryForm" style="background: linear-gradient(135deg, #fffbf5 0%, #f5f5f5 100%); border: 4px solid #2C2C2C; border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1.5rem; color: #c19a6b; font-weight: 900;">Create New Lottery</h3>

                    <div class="form-group">
                        <label for="lotteryPrizePool">Prize Pool (tokens) - Winner receives this amount</label>
                        <input type="number" id="lotteryPrizePool" min="1" value="100" style="width: 100%; padding: 0.75rem; border: 4px solid #2C2C2C; border-radius: 12px; font-weight: 600; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                        <small style="color: #666; font-size: 0.85rem; display: block; margin-top: 0.5rem;">This is the fixed amount the winner will receive</small>
                    </div>

                    <div class="form-group">
                        <label for="lotteryTicketPrice">Ticket Price (tokens)</label>
                        <input type="number" id="lotteryTicketPrice" min="1" value="10" style="width: 100%; padding: 0.75rem; border: 4px solid #2C2C2C; border-radius: 12px; font-weight: 600; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                        <small style="color: #666; font-size: 0.85rem; display: block; margin-top: 0.5rem;">Tokens spent on tickets disappear (not added to prize pool)</small>
                    </div>

                    <div class="form-group">
                        <label for="lotteryDuration">Duration (hours)</label>
                        <input type="number" id="lotteryDuration" min="1" value="24" style="width: 100%; padding: 0.75rem; border: 4px solid #2C2C2C; border-radius: 12px; font-weight: 600; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                    </div>

                    <button onclick="createLottery()" class="btn" style="width: 100%; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C; padding: 1rem; font-size: 1rem;">
                        üé∞ Create Lottery
                    </button>
                </div>

                <!-- Active Lottery Controls -->
                <div id="activeLotteryControls" style="display: none; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 4px solid #ff9800; border-radius: 16px; padding: 2rem;">
                    <h3 style="margin-bottom: 1.5rem; color: #ff9800; font-weight: 900;">Active Lottery Controls</h3>

                    <div style="display: flex; gap: 1rem;">
                        <button onclick="endLottery()" class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976d2 100%); border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">
                            üèÅ End Lottery Now
                        </button>
                        <button onclick="cancelLottery()" class="btn btn-danger" style="flex: 1; border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">
                            ‚ùå Cancel & Refund
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Management (Admin Only) -->
        <div class="section">
            <div class="section-header">
                <h2>üì¨ Notification Management</h2>
                <span class="section-toggle collapsed">‚ñº</span>
            </div>
            <div class="section-content">
                <p style="color: #666; margin-bottom: 1.5rem;">
                    Clear all unread notifications for all users across all chats and lounge.
                </p>
                <button onclick="markAllAsRead()" class="btn" style="background: #2196F3; margin-right: 1rem;">
                    Mark All as Read (Global)
                </button>
                <button onclick="clearAllReadReceipts()" class="btn btn-warning">
                    Reset All Read Receipts
                </button>
                <div id="notificationResult" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
            </div>
        </div>
        {% endif %}

        <!-- Play Analytics (Admin/Ambassador) -->
        {% if user_role in ['admin', 'ambassador'] %}
        <div class="section">
            <div class="section-header">
                <h2>Play Analytics</h2>
                <span class="section-toggle collapsed">‚ñº</span>
            </div>
            <div class="section-content">
                <div id="playStatsList" style="display: flex; flex-direction: column; gap: 1rem;">
                    <p style="text-align: center; color: #999;">Loading analytics...</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Feedback from Users (Admin/Ambassador) -->
        {% if user_role in ['admin', 'ambassador'] %}
        <div class="section">
            <div class="section-header">
                <h2>User Feedback</h2>
                <span class="section-toggle collapsed">‚ñº</span>
            </div>
            <div class="section-content">
                <div class="user-list">
                    {% if feedback %}
                        {% for fb in feedback %}
                        <div class="feedback-item">
                            <div class="feedback-content">
                                <div class="feedback-header">
                                    <span class="feedback-username">{{ fb.username }}</span>
                                    <span class="feedback-time">{{ fb.timestamp | format_time }}</span>
                                </div>
                                <div class="feedback-text">{{ fb.text }}</div>
                            </div>
                            <div class="actions">
                                <a href="{{ url_for('delete_feedback', index=loop.index0) }}" class="btn btn-success action-btn">Mark as Read</a>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-access">No feedback submitted yet</div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

    <!-- AI Management Section (Admin Only) -->
{% if user_role == 'admin' %}
<div class="section">
    <div class="section-header">
        <h2>AI Management</h2>
        <span class="section-toggle collapsed">‚ñº</span>
    </div>
    <div class="section-content">

        <!-- AI Settings -->
        <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 5px solid #2C2C2C; border-radius: 20px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 6px 0 rgba(44, 74, 107, 0.3);">
            <h3 style="margin-bottom: 1.5rem; color: #1e3a5f; font-weight: 900;">‚öôÔ∏è Settings</h3>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <!-- Enable/Disable AI -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 700;">AI Status</label>
                    <button id="aiToggleBtn" onclick="toggleAI()" class="btn" style="width: 100%; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">
                        <span id="aiStatusText">Loading...</span>
                    </button>
                </div>

                <!-- Daily Limit -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 700;">Daily Limit (per user)</label>
                    <input type="number" id="aiDailyLimit" min="1" max="100" style="width: 100%; padding: 0.75rem; border: 4px solid #2C2C2C; border-radius: 12px; font-weight: 600; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                </div>

                <!-- Hourly Limit -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 700;">Hourly Limit (per user)</label>
                    <input type="number" id="aiHourlyLimit" min="1" max="20" style="width: 100%; padding: 0.75rem; border: 4px solid #2C2C2C; border-radius: 12px; font-weight: 600; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                </div>

                <!-- Token Cost -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 700;">Token Cost (per request)</label>
                    <input type="number" id="aiTokenCost" min="1" max="50" style="width: 100%; padding: 0.75rem; border: 4px solid #2C2C2C; border-radius: 12px; font-weight: 600; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                </div>

                <!-- Cooldown -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 700;">Cooldown (seconds)</label>
                    <input type="number" id="aiCooldown" min="0" max="300" style="width: 100%; padding: 0.75rem; border: 4px solid #2C2C2C; border-radius: 12px; font-weight: 600; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                </div>

                <!-- Max Input Length -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 700;">Max Input Length (chars)</label>
                    <input type="number" id="aiMaxInput" min="100" max="2000" style="width: 100%; padding: 0.75rem; border: 4px solid #2C2C2C; border-radius: 12px; font-weight: 600; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                </div>

                <!-- Max Output Tokens -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 700;">Max Output Tokens</label>
                    <input type="number" id="aiMaxOutput" min="50" max="500" style="width: 100%; padding: 0.75rem; border: 4px solid #2C2C2C; border-radius: 12px; font-weight: 600; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                </div>
            </div>

            <button onclick="saveAISettings()" class="btn" style="width: 100%; margin-top: 1.5rem; background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%); border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">
                üíæ Save Settings
            </button>
        </div>

        <!-- Cost Analytics -->
        <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 5px solid #ff9800; border-radius: 20px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 6px 0 rgba(255, 152, 0, 0.3);">
            <h3 style="margin-bottom: 1.5rem; color: #e65100; font-weight: 900;">üí∞ Cost Analytics</h3>

            <div id="costAnalytics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div style="background: rgba(255, 255, 255, 0.7); border: 3px solid #ff9800; border-radius: 12px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.85rem; color: #666; font-weight: 700; margin-bottom: 0.5rem;">TODAY</div>
                    <div style="font-size: 1.5rem; font-weight: 900; color: #e65100;" id="todayRequests">0</div>
                    <div style="font-size: 0.75rem; color: #999; margin-top: 0.25rem;">requests</div>
                    <div style="font-size: 1.2rem; font-weight: 900; color: #ff9800; margin-top: 0.5rem;" id="todayCost">$0.00</div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.7); border: 3px solid #ff9800; border-radius: 12px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.85rem; color: #666; font-weight: 700; margin-bottom: 0.5rem;">REALISTIC MONTHLY</div>
                    <div style="font-size: 1.5rem; font-weight: 900; color: #e65100;" id="realisticRequests">0</div>
                    <div style="font-size: 0.75rem; color: #999; margin-top: 0.25rem;">requests</div>
                    <div style="font-size: 1.2rem; font-weight: 900; color: #ff9800; margin-top: 0.5rem;" id="realisticCost">$0.00</div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.7); border: 3px solid #ff9800; border-radius: 12px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.85rem; color: #666; font-weight: 700; margin-bottom: 0.5rem;">WORST CASE MONTHLY</div>
                    <div style="font-size: 1.5rem; font-weight: 900; color: #e65100;" id="worstCaseRequests">0</div>
                    <div style="font-size: 0.75rem; color: #999; margin-top: 0.25rem;">requests</div>
                    <div style="font-size: 1.2rem; font-weight: 900; color: #f44336; margin-top: 0.5rem;" id="worstCaseCost">$0.00</div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.7); border: 3px solid #ff9800; border-radius: 12px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.85rem; color: #666; font-weight: 700; margin-bottom: 0.5rem;">COST PER USER</div>
                    <div style="font-size: 1.5rem; font-weight: 900; color: #e65100;" id="registeredUsers">0</div>
                    <div style="font-size: 0.75rem; color: #999; margin-top: 0.25rem;">users</div>
                    <div style="font-size: 1.2rem; font-weight: 900; color: #ff9800; margin-top: 0.5rem;" id="costPerUser">$0.00</div>
                </div>
            </div>

            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255, 255, 255, 0.5); border-radius: 12px; border: 3px solid #ff9800;">
                <div style="font-size: 0.85rem; color: #666; font-weight: 700; margin-bottom: 0.5rem;">SETTINGS</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; font-size: 0.9rem; color: #666; font-weight: 600;">
                    <div>Model: <strong id="aiModel">gpt-4o-mini</strong></div>
                    <div>Registered Users: <strong id="totalUsers">0</strong></div>
                    <div>Daily Limit: <strong id="displayDailyLimit">0</strong></div>
                    <div>Max Output: <strong id="displayMaxOutput">0</strong> tokens</div>
                </div>
            </div>

            <button onclick="refreshCostAnalytics()" class="btn" style="width: 100%; margin-top: 1rem; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">
                üîÑ Refresh Analytics
            </button>
        </div>

        <!-- Usage Statistics -->
        <div style="background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%); border: 5px solid #2C2C2C; border-radius: 20px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 6px 0 rgba(44, 74, 107, 0.3);">
            <h3 style="margin-bottom: 1.5rem; color: #1e3a5f; font-weight: 900;">üìä Usage Statistics (Today)</h3>

            <div id="usageStats">
                <p style="text-align: center; color: #999;">Loading...</p>
            </div>
        </div>

        <!-- User Access Control -->
        <div style="background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%); border: 5px solid #2C2C2C; border-radius: 20px; padding: 2rem; box-shadow: 0 6px 0 rgba(44, 74, 107, 0.3);">
            <h3 style="margin-bottom: 1.5rem; color: #1e3a5f; font-weight: 900;">üë• User Access Control</h3>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <!-- Whitelist User -->
                <div style="background: #e8f5e9; border: 3px solid #4caf50; border-radius: 12px; padding: 1.5rem;">
                    <h4 style="color: #2e7d32; margin-bottom: 1rem; font-weight: 900;">‚úÖ Whitelist User</h4>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem; font-weight: 600;">Whitelisted users bypass all rate limits</p>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="whitelistUsername" placeholder="Username" style="flex: 1; padding: 0.75rem; border: 3px solid #4caf50; border-radius: 8px; font-weight: 600;">
                        <button onclick="toggleUserAccess('whitelist')" class="btn" style="background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%); padding: 0.75rem 1.5rem; border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">Add</button>
                    </div>
                </div>

                <!-- Blacklist User -->
                <div style="background: #ffebee; border: 3px solid #f44336; border-radius: 12px; padding: 1.5rem;">
                    <h4 style="color: #c62828; margin-bottom: 1rem; font-weight: 900;">üö´ Blacklist User</h4>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem; font-weight: 600;">Blacklisted users cannot use AI</p>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="blacklistUsername" placeholder="Username" style="flex: 1; padding: 0.75rem; border: 3px solid #f44336; border-radius: 8px; font-weight: 600;">
                        <button onclick="toggleUserAccess('blacklist')" class="btn btn-danger" style="padding: 0.75rem 1.5rem; border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">Block</button>
                    </div>
                </div>

                <!-- Remove User -->
                <div style="background: #fff3e0; border: 3px solid #ff9800; border-radius: 12px; padding: 1.5rem;">
                    <h4 style="color: #e65100; margin-bottom: 1rem; font-weight: 900;">‚Ü©Ô∏è Reset User</h4>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem; font-weight: 600;">Remove user from whitelist/blacklist</p>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="normalUsername" placeholder="Username" style="flex: 1; padding: 0.75rem; border: 3px solid #ff9800; border-radius: 8px; font-weight: 600;">
                        <button onclick="toggleUserAccess('normal')" class="btn btn-warning" style="padding: 0.75rem 1.5rem; border: 4px solid #2C2C2C; box-shadow: 0 4px 0 #2C2C2C;">Reset</button>
                    </div>
                </div>
            </div>

            <!-- Current Lists -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div style="background: #f5f5f5; border: 3px solid #2C2C2C; border-radius: 12px; padding: 1rem;">
                    <h4 style="color: #4caf50; margin-bottom: 0.75rem; font-weight: 900;">Whitelisted Users</h4>
                    <div id="whitelistDisplay" style="font-size: 0.9rem; color: #666; font-weight: 600;">
                        Loading...
                    </div>
                </div>
                <div style="background: #f5f5f5; border: 3px solid #2C2C2C; border-radius: 12px; padding: 1rem;">
                    <h4 style="color: #f44336; margin-bottom: 0.75rem; font-weight: 900;">Blacklisted Users</h4>
                    <div id="blacklistDisplay" style="font-size: 0.9rem; color: #666; font-weight: 600;">
                        Loading...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// AI Management Scripts
let currentAISettings = {};

// Load AI settings
async function loadAISettings() {
    try {
        const response = await fetch('/api/ai_settings');
        const data = await response.json();
        currentAISettings = data;

        document.getElementById('aiDailyLimit').value = data.daily_limit;
        document.getElementById('aiHourlyLimit').value = data.hourly_limit;
        document.getElementById('aiTokenCost').value = data.token_cost;
        document.getElementById('aiCooldown').value = data.cooldown_seconds;
        document.getElementById('aiMaxInput').value = data.max_input_length;
        document.getElementById('aiMaxOutput').value = data.max_output_tokens;

        const toggleBtn = document.getElementById('aiToggleBtn');
        const statusText = document.getElementById('aiStatusText');
        if (data.enabled) {
            toggleBtn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
            statusText.textContent = '‚úÖ AI Enabled';
        } else {
            toggleBtn.style.background = 'linear-gradient(135deg, #f44336 0%, #e53935 100%)';
            statusText.textContent = '‚ùå AI Disabled';
        }

        updateAccessLists(data);
    } catch (error) {
        console.error('Error loading AI settings:', error);
    }
}

async function saveAISettings() {
    const settings = {
        enabled: currentAISettings.enabled,
        daily_limit: parseInt(document.getElementById('aiDailyLimit').value),
        hourly_limit: parseInt(document.getElementById('aiHourlyLimit').value),
        token_cost: parseInt(document.getElementById('aiTokenCost').value),
        cooldown_seconds: parseInt(document.getElementById('aiCooldown').value),
        max_input_length: parseInt(document.getElementById('aiMaxInput').value),
        max_output_tokens: parseInt(document.getElementById('aiMaxOutput').value)
    };

    try {
        const response = await fetch('/api/ai_settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });

        const data = await response.json();
        if (data.success) {
            alert('‚úÖ Settings saved successfully!');
            loadAISettings();
            refreshCostAnalytics();
        } else {
            alert('‚ùå Error saving settings');
        }
    } catch (error) {
        console.error('Error saving AI settings:', error);
        alert('‚ùå Error saving settings');
    }
}

async function toggleAI() {
    currentAISettings.enabled = !currentAISettings.enabled;
    await saveAISettings();
}

async function refreshCostAnalytics() {
    try {
        const response = await fetch('/api/ai_cost_analytics');
        const data = await response.json();

        document.getElementById('todayRequests').textContent = data.today.requests;
        document.getElementById('todayCost').textContent = `$${data.today.cost.toFixed(4)}`;
        document.getElementById('realisticRequests').textContent = data.projections.realistic.monthly_requests.toLocaleString();
        document.getElementById('realisticCost').textContent = `$${data.projections.realistic.monthly_cost.toFixed(2)}`;
        document.getElementById('worstCaseRequests').textContent = data.projections.worst_case.monthly_requests.toLocaleString();
        document.getElementById('worstCaseCost').textContent = `$${data.projections.worst_case.monthly_cost.toFixed(2)}`;
        document.getElementById('costPerUser').textContent = `$${data.projections.worst_case.cost_per_user.toFixed(4)}`;
        document.getElementById('aiModel').textContent = data.settings.model;
        document.getElementById('totalUsers').textContent = data.settings.registered_users;
        document.getElementById('registeredUsers').textContent = data.settings.registered_users;
        document.getElementById('displayDailyLimit').textContent = data.settings.daily_limit;
        document.getElementById('displayMaxOutput').textContent = data.settings.max_output_tokens;
    } catch (error) {
        console.error('Error loading cost analytics:', error);
    }
}

async function loadUsageStats() {
    try {
        const response = await fetch('/api/ai_usage_stats');
        const data = await response.json();
        const statsDiv = document.getElementById('usageStats');

        if (data.stats.length === 0) {
            statsDiv.innerHTML = '<p style="text-align: center; color: #999;">No usage today</p>';
            return;
        }

        let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
        data.stats.forEach(stat => {
            html += `
                <div style="background: #f5f5f5; border: 3px solid #2C2C2C; border-left: 8px solid #64b5f6; border-radius: 12px; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 900; color: #1e3a5f; font-size: 1.1rem;">${stat.username}</div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem; font-weight: 600;">Last: ${stat.last_request}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%); color: white; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 900; border: 3px solid #2C2C2C;">
                        ${stat.today_count} requests
                    </div>
                </div>
            `;
        });
        html += '</div>';
        statsDiv.innerHTML = html;
    } catch (error) {
        console.error('Error loading usage stats:', error);
    }
}

async function toggleUserAccess(action) {
    let username;
    if (action === 'whitelist') {
        username = document.getElementById('whitelistUsername').value.trim();
    } else if (action === 'blacklist') {
        username = document.getElementById('blacklistUsername').value.trim();
    } else {
        username = document.getElementById('normalUsername').value.trim();
    }

    if (!username) {
        alert('Please enter a username');
        return;
    }

    try {
        const response = await fetch('/api/ai_toggle_user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: username, action: action })
        });

        const data = await response.json();
        if (data.success) {
            alert(`‚úÖ User ${username} ${action === 'whitelist' ? 'whitelisted' : action === 'blacklist' ? 'blacklisted' : 'reset'} successfully!`);
            document.getElementById('whitelistUsername').value = '';
            document.getElementById('blacklistUsername').value = '';
            document.getElementById('normalUsername').value = '';
            loadAISettings();
        } else {
            alert('‚ùå Error updating user access');
        }
    } catch (error) {
        console.error('Error toggling user access:', error);
        alert('‚ùå Error updating user access');
    }
}

function updateAccessLists(data) {
    const whitelistDiv = document.getElementById('whitelistDisplay');
    const blacklistDiv = document.getElementById('blacklistDisplay');

    if (data.whitelisted_users && data.whitelisted_users.length > 0) {
        whitelistDiv.innerHTML = data.whitelisted_users.map(user =>
            `<div style="padding: 0.5rem; background: white; border-radius: 6px; margin-bottom: 0.5rem; border: 2px solid #4caf50;">‚úÖ ${user}</div>`
        ).join('');
    } else {
        whitelistDiv.innerHTML = '<div style="color: #999; font-style: italic;">No whitelisted users</div>';
    }

    if (data.blacklisted_users && data.blacklisted_users.length > 0) {
        blacklistDiv.innerHTML = data.blacklisted_users.map(user =>
            `<div style="padding: 0.5rem; background: white; border-radius: 6px; margin-bottom: 0.5rem; border: 2px solid #f44336;">üö´ ${user}</div>`
        ).join('');
    } else {
        blacklistDiv.innerHTML = '<div style="color: #999; font-style: italic;">No blacklisted users</div>';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const aiSection = Array.from(document.querySelectorAll('.section-header')).find(
        header => header.textContent.includes('AI Management')
    );

    if (aiSection) {
        aiSection.addEventListener('click', function() {
            if (this.nextElementSibling.classList.contains('active')) {
                loadAISettings();
                refreshCostAnalytics();
                loadUsageStats();

                const refreshInterval = setInterval(() => {
                    if (this.nextElementSibling.classList.contains('active')) {
                        loadUsageStats();
                        refreshCostAnalytics();
                    } else {
                        clearInterval(refreshInterval);
                    }
                }, 30000);
            }
        });
    }
});
</script>
{% endif %}

    </div> <!-- END OF CONTAINER -->

    <!-- Chat Modal -->
    <div id="chatModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
        <div style="background: white; max-width: 800px; margin: 2rem auto; border-radius: 20px; border: 6px solid #2C2C2C; padding: 2rem; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 id="chatModalTitle">Chat Messages</h2>
                <button onclick="closeChatModal()" style="background: linear-gradient(135deg, #c00 0%, #a00 100%); color: white; border: 3px solid #2C2C2C; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 700; box-shadow: 0 3px 0 #2C2C2C;">Close</button>
            </div>
            <div id="chatModalContent"></div>
        </div>
    </div>

    <!-- Edit Game Modal -->
    <div id="editGameModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
        <div style="background: white; max-width: 800px; margin: 2rem auto; border-radius: 20px; border: 6px solid #2C2C2C; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 id="editGameTitle">Edit Game</h2>
                <button onclick="closeEditGameModal()" style="background: linear-gradient(135deg, #c00 0%, #a00 100%); color: white; border: 3px solid #2C2C2C; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 700; box-shadow: 0 3px 0 #2C2C2C;">Close</button>
            </div>
            <form method="POST" id="editGameForm">
                <div class="form-group">
                    <label for="edit_html_content">HTML Code</label>
                    <textarea id="edit_html_content" name="html_content" style="min-height: 300px;" required></textarea>
                </div>
                <button type="submit" style="background: linear-gradient(135deg, #c19a6b 0%, #d4af7a 100%); color: white; border: 4px solid #2C2C2C; padding: 0.75rem 1.5rem; border-radius: 12px; cursor: pointer; font-weight: 700; box-shadow: 0 4px 0 #2C2C2C;">Update Game</button>
            </form>
        </div>
    </div>

    <!-- Game Access Modal -->
    <div id="gameAccessModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
        <div style="background: white; max-width: 600px; margin: 2rem auto; border-radius: 20px; border: 6px solid #2C2C2C; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 4px solid #2C2C2C;">
                <h2 id="gameAccessTitle" style="margin: 0; color: #9c27b0; font-weight: 900;">Manage Game Access</h2>
                <button onclick="closeGameAccessModal()" style="background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%); color: white; border: 3px solid #2C2C2C; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; font-weight: 900; display: flex; align-items: center; justify-content: center; transition: all 0.3s; box-shadow: 0 4px 0 #2C2C2C;">√ó</button>
            </div>
            <div id="gameAccessContent" style="max-height: 60vh; overflow-y: auto;">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Collapsible Sections
        document.querySelectorAll('.section-header').forEach(header => {
            header.addEventListener('click', function() {
                const content = this.nextElementSibling;
                const toggle = this.querySelector('.section-toggle');

                content.classList.toggle('active');
                toggle.classList.toggle('collapsed');
            });
        });

        // Search Functionality
        function searchSections() {
            const query = document.getElementById('adminSearch').value.toLowerCase();
            const sections = document.querySelectorAll('.section');

            sections.forEach(section => {
                const text = section.textContent.toLowerCase();
                if (text.includes(query)) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
        }

        // Clear Login Notifications
        function clearLoginNotifications() {
            if (!confirm('Clear all login notifications?')) {
                return;
            }

            fetch('/api/clear_login_notifications', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function showUserChats(username) {
            const messages = {{ messages | tojson }};
            const modalContent = document.getElementById('chatModalContent');
            const modalTitle = document.getElementById('chatModalTitle');

            modalTitle.textContent = `Chat Messages for ${username}`;

            let html = '';
            let foundMessages = false;

            for (const [chatKey, msgs] of Object.entries(messages)) {
                const participants = chatKey.split('-');
                if (participants.includes(username)) {
                    foundMessages = true;
                    const otherUser = participants[0] === username ? participants[1] : participants[0];

                    html += `<div style="background: linear-gradient(135deg, #fffbf5 0%, #f5f5f5 100%); border: 4px solid #2C2C2C; border-radius: 16px; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 4px 0 rgba(44, 44, 44, 0.3);">`;
                    html += `<h3 style="color: #c19a6b; margin-bottom: 1rem; font-weight: 900;">Conversation with ${otherUser}</h3>`;

                   msgs.forEach(msg => {
                       const isFromUser = msg.from === username;

                        if (msg.type === 'snap') {
                            html += `<div style="margin-bottom: 0.75rem; padding: 0.75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; border: 3px solid #2C2C2C; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">`;
                            html += `<div style="font-weight: 700; color: white; font-size: 0.85rem;">${msg.from} sent a Snap</div>`;
                            html += `<div style="margin: 0.5rem 0;"><img src="${msg.photo}" style="max-width: 300px; border-radius: 8px;" /></div>`;
                            html += `<div style="font-size: 0.75rem; color: rgba(255,255,255,0.8);">Opened: ${msg.opened ? 'Yes' : 'No'}</div>`;
                            html += `<div style="font-size: 0.75rem; color: rgba(255,255,255,0.8);">${msg.timestamp}</div>`;
                            html += `</div>`;
                        } else {
                            html += `<div style="margin-bottom: 0.75rem; padding: 0.75rem; background: ${isFromUser ? 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)' : 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)'}; border-radius: 12px; border: 3px solid #2C2C2C; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">`;
                            html += `<div style="font-weight: 700; color: ${isFromUser ? '#1976d2' : '#f57c00'}; font-size: 0.85rem;">${msg.from}</div>`;
                            html += `<div style="margin: 0.25rem 0; font-weight: 600;">${msg.text}</div>`;
                            const timeOnly = msg.timestamp.split(' ').slice(1).join(' ');
                            html += `<div style="font-size: 0.75rem; color: #999; font-weight: 600;">${timeOnly}</div>`;
                            html += `</div>`;
                        }
                    });

                    html += `</div>`;
                }
            }

            if (!foundMessages) {
                html = '<p style="text-align: center; color: #999; padding: 2rem;">No messages found for this user.</p>';
            }

            modalContent.innerHTML = html;
            document.getElementById('chatModal').style.display = 'block';
        }

        function closeChatModal() {
            document.getElementById('chatModal').style.display = 'none';
        }

        function submitTokenForm(username) {
            const newTokens = parseInt(document.getElementById(`token-input-${username}`).value);
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/panel/edit_token/${username}/${newTokens}`;
            document.body.appendChild(form);
            form.submit();
        }

        function submitPasswordForm(username) {
            const newPassword = document.getElementById(`password-${username}`).value;
            if (!newPassword) {
                alert('Please enter a new password');
                return;
            }
            if (confirm(`Change password for ${username}?`)) {
                document.getElementById(`new-password-${username}`).value = newPassword;
                document.getElementById(`password-form-${username}`).submit();
            }
        }

        function updateGamePrice(gameId) {
            const price = parseInt(document.getElementById(`price-${gameId}`).value);
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/panel/update_game_price/${gameId}`;
            form.innerHTML = `<input type="hidden" name="price" value="${price}">`;
            document.body.appendChild(form);
            form.submit();
        }

        function updateGameBackground(gameId) {
            const bgUrl = document.getElementById(`bg-${gameId}`).value.trim();
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/panel/update_game_background/${gameId}`;
            form.innerHTML = `<input type="hidden" name="background_image" value="${bgUrl}">`;
            document.body.appendChild(form);
            form.submit();
        }

        function confirmCodeCreation(event) {
            event.preventDefault();
            const code = document.getElementById('code').value.toUpperCase();
            const amount = document.getElementById('amount').value;

            if (confirm(`Create code ${code} worth ${amount} tokens?`)) {
                const form = event.target;
                form.submit();
            }
            return false;
        }

        function loadCodes() {
            fetch('/api/get_codes')
            .then(response => response.json())
                .then(data => {
                    const codesList = document.getElementById('codesList');

                    if (data.codes.length === 0) {
                        codesList.innerHTML = '<p style="text-align: center; color: #999;">No codes created yet</p>';
                        return;
                    }

                    codesList.innerHTML = data.codes.map(code => `
                        <div class="user-item">
                            <div class="user-info">
                                <div class="user-name">${code.code}</div>
                                <div class="user-status">
                                    ${code.tokens} OPEN AI tokens ‚Ä¢ Created by ${code.created_by} ‚Ä¢ ${code.created_at}
                                </div>
                            </div>
                            <div class="actions">
                                <button onclick="deleteCode('${code.code}')" class="btn btn-danger action-btn">Delete</button>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => console.error('Error loading codes:', error));
        }

        function deleteCode(code) {
            if (confirm(`Delete code ${code}?`)) {
                fetch(`/api/delete_code/${code}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadCodes();
                    }
                })
                .catch(error => console.error('Error deleting code:', error));
            }
        }

        // Load codes when admin panel loads
        if (document.getElementById('codesList')) {
            loadCodes();
        }

        function loadPlayStats() {
            fetch('/api/get_play_stats')
                .then(response => response.json())
                .then(data => {
                    const statsList = document.getElementById('playStatsList');

                    if (data.stats.length === 0) {
                        statsList.innerHTML = '<p style="text-align: center; color: #999;">No play data yet</p>';
                        return;
                    }

                    statsList.innerHTML = data.stats.map(user => {
                        const gamesList = user.games
                            .sort((a, b) => b.plays - a.plays)
                            .map(game => `${game.game_name}: <strong>${game.plays}</strong> play${game.plays !== 1 ? 's' : ''}`)
                            .join(' ‚Ä¢ ');

                        return `
                            <div class="user-item">
                                <div class="user-info">
                                    <div class="user-name">${user.username}</div>
                                    <div class="user-status">${gamesList}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                })
                .catch(error => console.error('Error loading play stats:', error));
        }

        // Load play stats when admin panel loads
        if (document.getElementById('playStatsList')) {
            loadPlayStats();
        }

        function showEditGameModal(gameId) {
            // Show modal with loading state
            document.getElementById('editGameModal').style.display = 'block';
            document.getElementById('edit_html_content').value = 'Loading...';
            document.getElementById('edit_html_content').disabled = true;

            // Fetch game HTML from server
            fetch(`/api/get_game_html/${gameId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Get game name from the metadata already loaded
                        const games = {{ games | tojson }};
                        const game = games[gameId];

                        document.getElementById('editGameTitle').textContent = `Edit: ${game.name}`;
                        document.getElementById('edit_html_content').value = data.html_content;
                        document.getElementById('edit_html_content').disabled = false;
                        document.getElementById('editGameForm').action = `/panel/update_game/${gameId}`;
                    } else {
                        alert('Error loading game: ' + data.error);
                        closeEditGameModal();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load game content');
                    closeEditGameModal();
                });
        }

        function closeEditGameModal() {
            document.getElementById('editGameModal').style.display = 'none';
        }

        // Game Access Management
        function showGameAccessModal(username) {
            const modal = document.getElementById('gameAccessModal');
            const title = document.getElementById('gameAccessTitle');
            const content = document.getElementById('gameAccessContent');

            title.textContent = `Manage Game Access - ${username}`;

            const games = {{ games | tojson }};
            const userGames = purchases[username] || [];

            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';

            for (const [gameId, game] of Object.entries(games)) {
                const hasAccess = userGames.includes(gameId) || game.free_for_all;
                const isPaid = !game.free_for_all;

                html += `
                    <div style="background: ${hasAccess ? 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)' : 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)'}; border: 4px solid #2C2C2C; border-radius: 12px; padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 3px 0 rgba(44, 44, 44, 0.3);">
                        <div style="flex: 1;">
                            <div style="font-weight: 900; color: #2C2C2C; margin-bottom: 0.25rem;">${game.name}</div>
                            <div style="font-size: 0.85rem; color: #666; font-weight: 600;">
                                ${game.free_for_all ? 'üÜì Free Game' : `üí∞ ${game.price} tokens`}
                                ${hasAccess ? ' ‚Ä¢ <strong style="color: #4caf50;">Has Access</strong>' : ' ‚Ä¢ <strong style="color: #ff9800;">No Access</strong>'}
                            </div>
                        </div>
                        ${isPaid ? `
                            <button onclick="toggleGameAccess('${username}', '${gameId}', ${hasAccess})"
                                    style="background: linear-gradient(135deg, ${hasAccess ? '#f44336' : '#4caf50'} 0%, ${hasAccess ? '#d32f2f' : '#388e3c'} 100%); color: white; border: 3px solid #2C2C2C; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 700; cursor: pointer; box-shadow: 0 3px 0 #2C2C2C;">
                                ${hasAccess ? '‚ùå Remove' : '‚úÖ Grant'}
                            </button>
                        ` : '<span style="color: #999; font-size: 0.85rem; font-style: italic;">Free for all</span>'}
                    </div>
                `;
            }

            html += '</div>';
            content.innerHTML = html;
            modal.style.display = 'flex';
        }

        function closeGameAccessModal() {
            document.getElementById('gameAccessModal').style.display = 'none';
        }

        function toggleGameAccess(username, gameId, currentlyHasAccess) {
            const action = currentlyHasAccess ? 'remove' : 'grant';

            fetch(`/panel/toggle_game_access/${username}/${gameId}/${action}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showGameAccessModal(username); // Refresh the modal
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update game access');
            });
        }

        // Maintenance Mode Functions
        let noteCounter = 0;

        function loadMaintenanceStatus() {
            fetch('/api/get_maintenance_status')
                .then(response => response.json())
                .then(data => {
                    updateMaintenanceUI(data.enabled);
                })
                .catch(error => console.error('Error loading maintenance status:', error));
        }

        function loadMaintenanceNotes() {
            fetch('/api/get_maintenance_notes')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('maintenanceTitle').value = data.title || "What's Coming";

                    const notesContainer = document.getElementById('notesContainer');
                    notesContainer.innerHTML = '';

                    if (data.notes && data.notes.length > 0) {
                        data.notes.forEach(note => {
                            addNoteField(note);
                        });
                    } else {
                        addNoteField();
                    }
                })
                .catch(error => console.error('Error loading maintenance notes:', error));
        }

        function addNoteField(value = '') {
            const notesContainer = document.getElementById('notesContainer');
            const noteId = `note-${noteCounter++}`;

            const noteDiv = document.createElement('div');
            noteDiv.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
            noteDiv.innerHTML = `
                <input type="text" id="${noteId}" value="${value}" placeholder="Enter note" style="flex: 1; padding: 0.75rem; border: 1px solid #e0e0e0; border-radius: 8px;">
                <button onclick="this.parentElement.remove()" class="btn btn-danger" style="padding: 0.75rem 1rem;">‚úï</button>
            `;

            notesContainer.appendChild(noteDiv);
        }

        function saveMaintenanceNotes() {
            const title = document.getElementById('maintenanceTitle').value.trim();
            const noteInputs = document.querySelectorAll('#notesContainer input[type="text"]');
            const notes = Array.from(noteInputs)
                .map(input => input.value.trim())
                .filter(note => note.length > 0);

            fetch('/api/update_maintenance_notes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: title || "What's Coming",
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Maintenance message saved!');
                }
            })
            .catch(error => {
                console.error('Error saving maintenance notes:', error);
                alert('Failed to save maintenance message');
            });
        }

        function updateMaintenanceUI(enabled) {
            const toggleBtn = document.getElementById('maintenanceToggle');
            const statusText = document.getElementById('maintenanceStatus');
            const indicator = document.getElementById('maintenanceIndicator');

            if (enabled) {
                toggleBtn.style.background = '#4caf50';
                statusText.textContent = '‚úì Maintenance Mode: ON';
                indicator.textContent = 'üöß Website is in maintenance mode';
                indicator.style.color = '#ff9800';
            } else {
                toggleBtn.style.background = '#2196F3';
                statusText.textContent = '‚óã Maintenance Mode: OFF';
                indicator.textContent = '‚úì Website is accessible';
                indicator.style.color = '#4caf50';
            }
        }

        function toggleMaintenance() {
            if (!confirm('Are you sure you want to toggle maintenance mode? This will affect all users except admins and ambassadors.')) {
                return;
            }

            fetch('/api/toggle_maintenance', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateMaintenanceUI(data.enabled);
                    alert(data.enabled ? 'Maintenance mode ENABLED' : 'Maintenance mode DISABLED');
                }
            })
            .catch(error => {
                console.error('Error toggling maintenance:', error);
                alert('Failed to toggle maintenance mode');
            });
        }

        // Set up event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const maintenanceToggle = document.getElementById('maintenanceToggle');
            if (maintenanceToggle) {
                maintenanceToggle.addEventListener('click', toggleMaintenance);
                loadMaintenanceStatus();
                loadMaintenanceNotes();
            }
        });

        function resetCookie() {
            if (confirm('Reset the fortune cookie? This will make it claimable again.')) {
                fetch('/api/reset_cookie', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Fortune cookie reset successfully!');
                    }
                })
                .catch(error => {
                    console.error('Error resetting cookie:', error);
                    alert('Failed to reset cookie');
                });
            }
        }

        async function markAllAsRead() {
            if (!confirm('Mark all messages as read for ALL users?\n\nThis will clear all unread notifications.')) {
                return;
            }

            const resultDiv = document.getElementById('notificationResult');
            resultDiv.style.display = 'block';
            resultDiv.style.background = '#e3f2fd';
            resultDiv.style.border = '1px solid #2196F3';
            resultDiv.textContent = 'Processing...';

            try {
                const response = await fetch('/api/mark_all_as_read', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.background = '#e8f5e9';
                    resultDiv.style.border = '1px solid #4caf50';
                    resultDiv.textContent = `‚úì Success! Marked all messages as read for all users.`;
                } else {
                    resultDiv.style.background = '#ffebee';
                    resultDiv.style.border = '1px solid #f44336';
                    resultDiv.textContent = `‚úó Error: ${data.error || 'Unknown error'}`;
                }
            } catch (error) {
                resultDiv.style.background = '#ffebee';
                resultDiv.style.border = '1px solid #f44336';
                resultDiv.textContent = `‚úó Network error: ${error.message}`;
            }

            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }

        async function clearAllReadReceipts() {
            if (!confirm('‚ö†Ô∏è WARNING: This will DELETE all read receipt data!\n\nAll notification history will be lost. Continue?')) {
                return;
            }

            if (!confirm('This action CANNOT be undone. Are you sure?')) {
                return;
            }

            const resultDiv = document.getElementById('notificationResult');
            resultDiv.style.display = 'block';
            resultDiv.style.background = '#fff3e0';
            resultDiv.style.border = '1px solid #ff9800';
            resultDiv.textContent = 'Deleting all read receipts...';

            try {
                const response = await fetch('/api/clear_all_read_receipts', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.background = '#e8f5e9';
                    resultDiv.style.border = '1px solid #4caf50';
                    resultDiv.textContent = `‚úì Success! All read receipts cleared. File will be recreated automatically.`;
                } else {
                    resultDiv.style.background = '#ffebee';
                    resultDiv.style.border = '1px solid #f44336';
                    resultDiv.textContent = `‚úó Error: ${data.error || 'Unknown error'}`;
                }
            } catch (error) {
                resultDiv.style.background = '#ffebee';
                resultDiv.style.border = '1px solid #f44336';
                resultDiv.textContent = `‚úó Network error: ${error.message}`;
            }

            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }

        function toggleHtmlInput() {
            const useTextarea = document.getElementById('use_textarea').checked;
            const textarea = document.getElementById('html_content');
            const fileInput = document.getElementById('html_file');

            if (useTextarea) {
                textarea.style.display = 'block';
                textarea.required = true;
                fileInput.style.display = 'none';
                fileInput.required = false;
            } else {
                textarea.style.display = 'none';
                textarea.required = false;
                fileInput.style.display = 'block';
                fileInput.required = true;
            }
        }

        // ===== LOTTERY MANAGEMENT =====

        function loadLotteryStatus() {
            fetch('/api/lottery_info')
                .then(response => response.json())
                .then(data => {
                    const statusContent = document.getElementById('lotteryStatusContent');
                    const createForm = document.getElementById('createLotteryForm');
                    const activeControls = document.getElementById('activeLotteryControls');

                    if (data.active) {
                        createForm.style.display = 'none';
                        activeControls.style.display = 'block';

                        statusContent.innerHTML = `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div style="text-align: center; background: rgba(255, 215, 0, 0.1); border: 3px solid #FFD700; border-radius: 12px; padding: 1rem;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; font-weight: 700;">PRIZE POOL</div>
                                    <div style="font-size: 1.5rem; font-weight: 900; color: #FFD700;">${data.prize_pool} üéüÔ∏è</div>
                                </div>
                                <div style="text-align: center; background: rgba(193, 154, 107, 0.1); border: 3px solid #c19a6b; border-radius: 12px; padding: 1rem;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; font-weight: 700;">TICKET PRICE</div>
                                    <div style="font-size: 1.5rem; font-weight: 900; color: #c19a6b;">${data.ticket_price} üéüÔ∏è</div>
                                </div>
                                <div style="text-align: center; background: rgba(33, 150, 243, 0.1); border: 3px solid #2196F3; border-radius: 12px; padding: 1rem;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; font-weight: 700;">TOTAL TICKETS</div>
                                    <div style="font-size: 1.5rem; font-weight: 900; color: #2196F3;">${data.total_tickets} üé´</div>
                                </div>
                                <div style="text-align: center; background: rgba(76, 175, 80, 0.1); border: 3px solid #4caf50; border-radius: 12px; padding: 1rem;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; font-weight: 700;">PARTICIPANTS</div>
                                    <div style="font-size: 1.5rem; font-weight: 900; color: #4caf50;">${data.participants.length}</div>
                                </div>
                            </div>
                            <div style="margin-top: 1rem; text-align: center; padding: 1rem; background: rgba(255, 152, 0, 0.1); border: 3px solid #ff9800; border-radius: 12px;">
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; font-weight: 700;">ENDS AT</div>
                                <div style="font-size: 1.2rem; font-weight: 900; color: #ff9800;">${data.end_time}</div>
                            </div>
                        `;
                    } else {
                        createForm.style.display = 'block';
                        activeControls.style.display = 'none';

                        if (data.winner) {
                            statusContent.innerHTML = `
                                <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(193, 154, 107, 0.2) 100%); border: 4px solid #FFD700; border-radius: 16px;">
                                    <div style="font-size: 2rem; margin-bottom: 1rem;">üèÜ</div>
                                    <div style="font-size: 1.3rem; font-weight: 900; color: #FFD700; margin-bottom: 0.5rem;">
                                        Last Winner: ${data.winner}
                                    </div>
                                    <div style="font-size: 1rem; color: #666; font-weight: 700;">
                                        Won ${data.won_amount} üéüÔ∏è with ${data.winner_tickets}/${data.total_tickets_won} tickets
                                    </div>
                                    <div style="font-size: 0.85rem; color: #999; margin-top: 0.5rem; font-weight: 600;">
                                        ${data.won_at}
                                    </div>
                                </div>
                            `;
                        } else {
                            statusContent.innerHTML = `
                                <p style="text-align: center; color: #999; padding: 2rem; font-style: italic;">
                                    No active lottery. Create one below!
                                </p>
                            `;
                        }
                    }
                })
                .catch(error => console.error('Error loading lottery status:', error));
        }

        async function createLottery() {
            const ticketPrice = parseInt(document.getElementById('lotteryTicketPrice').value);
            const prizePool = parseInt(document.getElementById('lotteryPrizePool').value);
            const duration = parseInt(document.getElementById('lotteryDuration').value);

            if (!ticketPrice || ticketPrice < 1) {
                alert('Please enter a valid ticket price (minimum 1 token)');
                return;
            }

            if (!prizePool || prizePool < 1) {
                alert('Please enter a valid prize pool (minimum 1 token)');
                return;
            }

            if (!duration || duration < 1) {
                alert('Please enter a valid duration (minimum 1 hour)');
                return;
            }

            if (!confirm(`Create lottery with:\n‚Ä¢ Prize Pool: ${prizePool} tokens\n‚Ä¢ Ticket Price: ${ticketPrice} tokens\n‚Ä¢ Duration: ${duration} hours?`)) {
                return;
            }

            try {
                const response = await fetch('/api/lottery_create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ticket_price: ticketPrice,
                        prize_pool: prizePool,
                        duration_hours: duration
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Lottery created successfully!');
                    loadLotteryStatus();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to create lottery'));
                }
            } catch (error) {
                alert('‚ùå Failed to connect to server');
            }
        }

        async function endLottery() {
            if (!confirm('End the lottery now and pick a winner?\n\nThis cannot be undone!')) {
                return;
            }

            try {
                const response = await fetch('/api/lottery_end', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Lottery ended! Winner has been selected.');
                    loadLotteryStatus();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to end lottery'));
                }
            } catch (error) {
                alert('‚ùå Failed to connect to server');
            }
        }

        async function cancelLottery() {
            if (!confirm('Cancel the lottery and refund ALL participants?\n\nThis will refund all tickets purchased. This cannot be undone!')) {
                return;
            }

            if (!confirm('Are you absolutely sure? All progress will be lost.')) {
                return;
            }

            try {
                const response = await fetch('/api/lottery_cancel', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Lottery cancelled and all participants refunded.');
                    loadLotteryStatus();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to cancel lottery'));
                }
            } catch (error) {
                alert('‚ùå Failed to connect to server');
            }
        }

        // Load lottery status when admin panel loads
        if (document.getElementById('lotteryStatus')) {
            loadLotteryStatus();
            // Refresh every 30 seconds
            setInterval(loadLotteryStatus, 30000);
        }
    </script>
</body>
</html>